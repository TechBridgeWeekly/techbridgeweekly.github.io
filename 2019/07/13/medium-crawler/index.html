<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>Medium 爬蟲進化史 | TechBridge 技術共筆部落格</title>
  <meta name="description" content="TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、數據分析與產品設計等技術分享" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- google-site-verification -->
  <meta
    name="google-site-verification"
    content="bcOr2jIfPaRI5ngBviymG6zkEU_VN3sbfABLt0hsmoc"
  />
  <link
    rel="stylesheet preload"
    type="text/css"
    href="/css/screen.css"
    as="style"
  />
  <link
    rel="stylesheet preload"
    type="text/css"
    href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400"
    as="style"
  />

  <!-- Favicons -->
  <link rel="apple-touch-icon" href="/img/favicon.ico" />
  <link rel="icon preload" href="/img/favicon.ico" as="image" />

   
  <link
    rel="alternate"
    type="application/atom+xml"
    title="Atom 0.3"
    href="atom.xml"
  />
    
</head>


<body class="post-template">

  <header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo-tb-500-500.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">TechBridge 技術共筆部落格</h1>
            <h2 class="blog-description">var topics = ['Web前後端', '行動網路', '機器人/物聯網', '數據分析', '產品設計', 'etc.']</h2>
            <div class="navbar-block">
                <span><a href="/">首頁</a></span> / <span><a href="/about/">關於我們</a></span> / <span><a href="http://weekly.techbridge.cc/" target="_blank">技術週刊</a></span> / <span><a href="https://www.facebook.com/techbridge.cc/" target="_blank">粉絲專頁</a></span> / <span><a href="/atom.xml" target="_blank">訂閱RSS </a></span>
                <br>
            </div>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2019-07-13T08:39:38.000Z" itemprop="datePublished">
          2019-07-13
      </time>
    
    
    | 
    <a href='/tags/medium/'>medium</a>
    
    
</span>

<meta name="generator" content="Medium 爬蟲進化史">
<meta name="og:title" content="Medium 爬蟲進化史">
<meta name="og:description" content="TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、數據分析與產品設計等技術分享。">
<meta name="og:type" content="website">
<meta name="og:image" content="/img/og-cover.png">

    <h1 class="post-title">Medium 爬蟲進化史</h1>
    <section class="post-content">
      <div class="fb-like" data-href="https://www.facebook.com/techbridge.cc" data-layout="button_count" data-action="like" data-size="large" data-show-faces="false" data-share="true"></div>   
      <hr>
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前幾天的時候我在 Medium 上發了這篇文：<a target="_blank" rel="noopener" href="https://medium.com/@hulitw/medium-analysis-40752b9efa03">Medium 中文寫作者追蹤人數排名與不專業數據分析</a>，內文是我用 Node.js 寫了一個簡單的 Medium 爬蟲之後整理出來的數據。</p>
<p>在原本那篇文章裡面有簡單提到爬蟲的資料來源，但是對技術的部分沒有太多著墨。事實上，在寫 Medium 爬蟲的時候其實踩了一些坑，與其教大家寫一個 Medium 爬蟲，不如讓大家跟我一起走過這些坑，盡可能地還原我當初在寫這個爬蟲時碰到的障礙以及解決方法，我覺得這樣會更有趣一點。</p>
<p>因此，這篇就是用來記錄我寫這個 Medium 爬蟲的經過，其中也會有點教學的成份在，所以看完之後你應該也能夠寫出一個類似的爬蟲，或至少你看到 source code 的時候不會一頭霧水。</p>
<p>雖然說最後寫出來的是這個跟使用者資料有關的爬蟲，但我一開始其實是先從文章列表開始的，因為那時候剛好有一個需求，想要把自己的文章全部爬下來。</p>
<p>會有這個需求是因為 Medium 內建的功能其實滿爛的，你很難找到一個作者 po 過的所有文章，或者是說很難一目瞭然。所以早期的文章除了透過 Google 以外，是很難被找到的。</p>
<p>所以我後來就手動做了一個<a target="_blank" rel="noopener" href="https://aszx87410.github.io/blog/medium">文章的索引</a>，自己整理了以前發過的所有文章。但是身為工程師，這明明就是一件可以寫程式來做的事啊！所以想嘗試看看能不能先寫一個文章列表的爬蟲。</p>
<h2 id="第一次嘗試：尋找資料來源"><a href="#第一次嘗試：尋找資料來源" class="headerlink" title="第一次嘗試：尋找資料來源"></a>第一次嘗試：尋找資料來源</h2><p>對我來說，爬蟲的第一步也是最困難的一步就是找到資料來源。只要這一步完成了，其他的相比之下都比較簡單。</p>
<p>如果能拿到 Medium 的 API 那當然是最好的。若是沒有的話，就必須用 puppeteer 之類的東西去爬 HTML 然後自己 parse 了。</p>
<p>在 Medium 的文章列表那邊捲動一下並且打開 devtool，可以看到 medium 後面是用 GraphQL：</p>
<p><img src="/img/huli/medium/p1.png"></p>
<p>這個就麻煩了…我對 GraphQL 不太熟，要花時間去研究一下它的資料結構，感覺要花不少時間，於是那時我就暫時先放棄這條路，決定來試試看用 puppeteer。</p>
<h2 id="第二次嘗試：puppeteer"><a href="#第二次嘗試：puppeteer" class="headerlink" title="第二次嘗試：puppeteer"></a>第二次嘗試：puppeteer</h2><p>如果你不知道什麼是 puppeteer，我在這邊簡單介紹一下。你可以想成 puppeteer 會自動幫你打開一個瀏覽器，你可以寫程式去操控這個瀏覽器。例如說我要打開一個頁面並且在這頁面上執行 JS 等等，所以使用 puppeteer 的話，爬蟲的原理就是打開某個頁面，執行一段 JS 拿到頁面上的資料。</p>
<p>puppeteer 用起來很簡單，只要找一下現成的範例看一下語法，改一改就可以直接拿來用了。稍微研究了一下 HTML 結構之後，可以寫出下面的程式碼：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">&#x27;puppeteer&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="string">&#x27;hulitw&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">&#x27;https://medium.com/@&#x27;</span> + username</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">    <span class="attr">headless</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 造訪頁面</span></span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.<span class="title function_">newPage</span>()</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">goto</span>(url, &#123;</span><br><span class="line">    <span class="attr">waitUntil</span>: <span class="string">&#x27;domcontentloaded&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 執行準備好的 script 並回傳資料 </span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">await</span> page.<span class="title function_">evaluate</span>(mediumParser)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">close</span>()</span><br><span class="line">  <span class="keyword">await</span> browser.<span class="title function_">close</span>()</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mediumParser</span>(<span class="params"></span>) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// selector 是透過觀察而得來的</span></span><br><span class="line">  <span class="keyword">const</span> elements = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;section &gt; div:nth-child(2) &gt; div &gt; div&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> result = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; elements.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> h1 = elements[i].<span class="title function_">querySelector</span>(<span class="string">&#x27;h1&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> a = elements[i].<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (h1) &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: h1.<span class="property">innerText</span>,</span><br><span class="line">        <span class="attr">link</span>: a[<span class="number">3</span>].<span class="property">href</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="title function_">main</span>()</span><br></pre></td></tr></table></figure>

<p>只要觀察出 HTML 與 CSS 的規則之後，就可以取得想拿的資料。但 Medium 不好爬是因為在 class name 的部分有使用 <a href="https://blog.techbridge.cc/2019/01/26/functional-css/">functional CSS</a>，而且 class 的命名都有經過處理，看起來是用程式自動去跑的，所以只要 Medium 一更新，元素的命名應該會不太一樣。</p>
<p>所以最後只能從 HTML 的結構下手，去把文章給抓出來。</p>
<p>解決了這個問題之後，還有一個問題，那就是無限捲動。Medium 跟很多網頁一樣，要一直往下滑才會載入新文章，而這邊必須觀察的規律是滑到什麼時候才要停止。</p>
<p>觀察之後發現當發表過的文章載入完以後，才會顯示 <code>Highlighted by xxx</code> 這個區塊，所以可以用這個元素有沒有出現當作終止條件。</p>
<p>接著可以寫一段程式碼，讓頁面不斷往下捲動直到載入所有文章為止：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  要用的話就是： await scroll(page)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getArticlesCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> elements = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;section &gt; div:nth-child(2) &gt; div &gt; div&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> elements.<span class="property">length</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">scroll</span>(<span class="params">page</span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">evaluate</span>(<span class="string">&#x27;window.scrollTo(0, document.body.scrollHeight)&#x27;</span>)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 終止條件</span></span><br><span class="line">    <span class="keyword">await</span> page.<span class="title function_">waitForSelector</span>(<span class="string">&#x27;h4 ~ p&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">timeout</span>: <span class="number">1000</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 印出目前抓到的文章數目</span></span><br><span class="line">    <span class="keyword">const</span> count = <span class="keyword">await</span> page.<span class="title function_">evaluate</span>(getArticlesCount);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Fetching... <span class="subst">$&#123;count&#125;</span> articles`</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 繼續往下捲動</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">scroll</span>(page);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>為了在 console 上讓我能看到現在的進度（可以確認程式是不是有 bug），還加了一段是每一次捲動都會印出現在畫面上有的文章數量。</p>
<p>做到這邊，就可以抓到使用者所有的文章標題以及連結了。</p>
<p>那發文日期呢？也拿得到嗎？</p>
<p>拿得到，但是麻煩很多。看看下面的 Medium 截圖就知道了：</p>
<p><img src="/img/huli/medium/p2.png"></p>
<p>如果是今年（2019）的文章，就不會顯示年份，否則的話就會顯示出發文年份。所以這邊要再經過特殊的判斷處理，而且只拿得到日期，拿不到詳細發文時間。</p>
<p>做到這邊，我就懶得再繼續下去了。想說有很多眉眉角角要處理，而且抓到的資料有限，還不如轉去研究 API 比較實在。</p>
<h2 id="第三次嘗試：puppeteer-API"><a href="#第三次嘗試：puppeteer-API" class="headerlink" title="第三次嘗試：puppeteer + API"></a>第三次嘗試：puppeteer + API</h2><p>前面已經說過我那時對 GraphQL API 不熟，所以暫時放棄了。但是嘗試了 puppeteer 之後，反而讓我有了新的思路。</p>
<p>在 puppeteer 裡面你可以加上監聽 network response 的事件，而頁面在載入文章的時候，一定會呼叫 API 去拿文章。這樣子事情不就好辦多了嗎？我不用自己研究怎麼 call API，我讓頁面自己去 call API，我自己只要監聽 response，研究一下 response 的格式就行了！</p>
<p>程式碼大概是長這樣的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> apiResponses = []</span><br><span class="line">  </span><br><span class="line">page.<span class="title function_">on</span>(<span class="string">&#x27;response&#x27;</span>, <span class="title function_">async</span> (response) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">_url</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;graphql&#x27;</span>) &lt; <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">const</span> json = <span class="keyword">await</span> response.<span class="title function_">json</span>()</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> post = <span class="title function_">parsePosts</span>(json)</span><br><span class="line">      apiResponses.<span class="title function_">push</span>(...post)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parsePosts</span>(<span class="params">json</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = []</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 研究到一半沒做完</span></span><br><span class="line">    <span class="keyword">const</span> streams = json.<span class="property">data</span>.<span class="property">user</span>.<span class="property">profileStreamConnection</span>.<span class="property">stream</span></span><br><span class="line">    <span class="keyword">for</span> (stream <span class="keyword">of</span> streams) &#123;</span><br><span class="line">      <span class="keyword">if</span> (stream.<span class="property">itemType</span>.<span class="property">__typename</span> === <span class="string">&#x27;StreamItemCompressedPostList&#x27;</span>) &#123;</span><br><span class="line">  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次有新的 response 進來就可以解析一下並丟到 array 裡面，最後拿到的就會是完整的從 API 傳來的資料。</p>
<p>但後來我發現這條路也行不通。</p>
<p>為什麼呢？因為頁面在第一次載入的時候，從 Server 回傳的 HTML 就已經有前幾筆文章的資料了，往下捲動的時候才是使用 ajax 來載入新的文章。意思是說，如果我想靠監聽 ajax response 的方式拿到所有文章的資料是沒辦法的，前幾筆是拿不到的。</p>
<p>做到這邊的時候我有點心灰意冷，想說花了兩天寫出一個不能用的東西。抓取文章列表的部分做到這我就放棄了，懶得繼續花時間去研究，並且把心力轉向我真正想抓的東西。</p>
<p>最前面提到的抓文章列表的需求其實是突然蹦出來的，在這之前我有更想抓的東西：follower，我想統計臺灣寫作者的 follower 人數，然後看看自己可以排到第幾名（滿足一下虛榮心）。</p>
<p>在嘗試了抓文章列表並失敗以後，我有試過用類似的方式去抓 follower，但做到一半發現這樣抓的話效率也太差了，每次捲動載入 25 個 follower 的話，1000 人可是要捲動 40 次。</p>
<p>自己如果做不出來的話，答案就很明顯了：Google，就拜託你了！</p>
<h2 id="第四次嘗試：Google-大神"><a href="#第四次嘗試：Google-大神" class="headerlink" title="第四次嘗試：Google 大神"></a>第四次嘗試：Google 大神</h2><p>直接在 Google 打上關鍵字：<code>medium follower api</code>，出現的第一個搜尋結果是最無用的官方 API，幾乎什麼資料都沒給，而且要申請還要寄信給客服，有夠麻煩。</p>
<p>但是第二個搜尋結果讓我眼睛為之一亮，是一個 gist 檔案：<a target="_blank" rel="noopener" href="https://gist.github.com/newhouse/843c444ddefe084ea7f01603627dbcfd">Medium API: get number of followers for User · GitHub</a>。</p>
<p>程式碼才五十行而已，很短，掃過一遍可以看到最關鍵的一行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BUILD THE URL TO REQUEST FROM</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateMediumProfileUri</span>(<span class="params">username</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`https://medium.com/@<span class="subst">$&#123;username&#125;</span>?format=json`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>什麼！原來還有這招，在網址後面加 <code>?format=json</code> 就可以拿到 json 格式的資料，這真是太神奇了。</p>
<p>把得到的資料丟到 <a target="_blank" rel="noopener" href="https://jsonformatter.curiousconcept.com/">JSON Formatter</a> 之後，可以看到大概的結構：</p>
<p><img src="/img/huli/medium/p3.png"></p>
<p>在這邊可以拿到使用者的個人資料以及發過的一些文章，也可以拿到我們的目標：follower！</p>
<p>我們順便來看一下使用者資料可以拿到些什麼：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;user&quot;</span>:&#123;  </span><br><span class="line">   <span class="string">&quot;userId&quot;</span>:<span class="string">&quot;f1fb3e40dc37&quot;</span>,</span><br><span class="line">   <span class="string">&quot;name&quot;</span>:<span class="string">&quot;Huli&quot;</span>,</span><br><span class="line">   <span class="string">&quot;username&quot;</span>:<span class="string">&quot;hulitw&quot;</span>,</span><br><span class="line">   <span class="string">&quot;createdAt&quot;</span>:<span class="number">1487549030919</span>,</span><br><span class="line">   <span class="string">&quot;imageId&quot;</span>:<span class="string">&quot;1*WQyJUJBQpBNIHH8GEWE6Sg.jpeg&quot;</span>,</span><br><span class="line">   <span class="string">&quot;backgroundImageId&quot;</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">   <span class="string">&quot;bio&quot;</span>:<span class="string">&quot;自學程式，後來跑去唸哲學系但沒念完，前往新加坡工作了兩年半後決定放一年的假，到處旅遊。喜歡教學，發現自己好像有把事情講得簡單又清楚的能力，相信分享與交流可以讓世界更美好。\bMedium 文章列表請參考：https://aszx87410.github.io/blog/medium&quot;</span>,</span><br><span class="line">   <span class="string">&quot;allowNotes&quot;</span>:<span class="number">1</span>,</span><br><span class="line">   <span class="string">&quot;mediumMemberAt&quot;</span>:<span class="number">1542441600000</span>,</span><br><span class="line">   <span class="string">&quot;isNsfw&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">   <span class="string">&quot;isWriterProgramEnrolled&quot;</span>:<span class="literal">true</span>,</span><br><span class="line">   <span class="string">&quot;isQuarantined&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">   <span class="string">&quot;type&quot;</span>:<span class="string">&quot;User&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了基本的自介跟姓名以外，還可以拿到成為 Medium 付費會員的時間以及成為 Medium 會員的時間，還滿有趣的，還有一個 flag 也很有趣：isNsfw。</p>
<p>唯一缺的就是 follower 的清單了。</p>
<p>這邊我嘗試用一樣的方法，在 Medium 網址後面接了參數：<code>https://medium.com/@hulitw/followers?format=json</code>，沒想到還真的有東西！在 response 裡面可以找到 10 個 follower 的資料。</p>
<p>有了資料之後就確定這個 API 是有用的，再來直接跳到 response 最下面 paging 的部分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;paging&quot;</span>:&#123;  </span><br><span class="line">   <span class="string">&quot;path&quot;</span>:<span class="string">&quot;https://medium.com/_/api/users/f1fb3e40dc37/profile/stream&quot;</span>,</span><br><span class="line">   <span class="string">&quot;next&quot;</span>:&#123;  </span><br><span class="line">      <span class="string">&quot;limit&quot;</span>:<span class="number">10</span>,</span><br><span class="line">      <span class="string">&quot;to&quot;</span>:<span class="string">&quot;10590c54e527&quot;</span>,</span><br><span class="line">      <span class="string">&quot;source&quot;</span>:<span class="string">&quot;followers&quot;</span>,</span><br><span class="line">      <span class="string">&quot;page&quot;</span>:<span class="number">2</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>path 的部分看起來是個 API 網址，next 應該是參數，試著把這些參數帶到網址上面：<a target="_blank" rel="noopener" href="https://medium.com/_/api/users/f1fb3e40dc37/profile/stream?limit=10&to=10590c54e527&source=followers&page=2">https://medium.com/_/api/users/f1fb3e40dc37/profile/stream?limit=10&amp;to=10590c54e527&amp;source=followers&amp;page=2</a> ，就出現了只有 follower 相關的資料！</p>
<p><img src="/img/huli/medium/p4.png"></p>
<p>試著把 limit 換一下，發現最大值應該是 25，一次可以抓 25 筆資料；page 換一下之後發現沒什麼作用，於是把 to 也改一下，發現可以成功抓到新的資料。看來分頁機制是採用 cursor based 的。</p>
<p>在經過了幾次嘗試之後，終於拿到了兩個 API 的網址，一個可以獲得詳細個人資料，另外一個可以拿到 follower 的列表！</p>
<p>資料來源確定有了之後，就可以來構思一下爬蟲的架構了。</p>
<h2 id="爬蟲架構"><a href="#爬蟲架構" class="headerlink" title="爬蟲架構"></a>爬蟲架構</h2><p>我要怎麼樣才能儘可能爬到所有的台灣寫作者？</p>
<p>首先第一個問題是我們必須把範圍放大一點，因為中文寫作者裡面可能有香港來的或是中國來的，你比較難靠程式去辨別到底是哪裡來的，尤其是香港跟台灣，因為都使用繁體中文。</p>
<p>為了不讓問題變得更複雜，我們只要能抓到「中文使用者就好」。</p>
<p>那要怎麼樣才能抓到最多中文使用者？一個很簡單的策略就是我們預設中文使用者的 follower 應該都是中文使用者，所以我們只要從某個使用者開始，把他所有的 follower 都丟進一個 queue 裡面，一直持續這個動作就好。</p>
<p>用文字簡化就是這樣：</p>
<ol>
<li>從 queue 裡面拿出一個使用者</li>
<li>把他的資料寫進資料庫</li>
<li>把他的所有 follower 丟進 queue</li>
<li>回到步驟一</li>
</ol>
<p>這樣子就可以靠著一個使用者無限延伸出去，而且理論上來說可以抓到超級多使用者的資料。這邊之所有選擇 follower（追蹤我的人）而不是 following（我追蹤的人），是考量到追蹤的使用者可能會有別的國家的，例如說我可能會追蹤國外的工程師之類的，但因為我不寫英文，所以國外的工程師應該不會來追蹤我。這樣的話就可以讓使用者侷限在中文，符合我們的目標。</p>
<p>接著就是系統架構的部分，這邊依據你想達成的效率會有不同種做法。</p>
<p>對我來說效率會最高的就是找那種很適合用來當 queue 的 service，例如說 redis 之類的，然後資料庫的部分可以選用 MySQL 或任何你熟悉的軟體。這樣子的好處是你可以開不同機器，然後每一台機器都是一個 worker，例如說你開五台機器，就會有五個 worker 一直從 queue 裡面拿東西出來並且把 follower 丟進去。</p>
<p>這邊之所以開很多台機器而不是開很多 thread 或 process，是因為 rate limiting 的問題。一般 API 都會有流量限制，你如果同一個 IP 發太多 request 會被 ban 掉或者是一段時間拿不到 response，所以開再多 process 跟 thread 都沒有用，只能開不同機器來解決（或只要有辦法換 IP 的話就可以）。</p>
<p>後來因為我沒有很在乎效率而且懶得開很多機器，所以只打算開一台讓他慢慢抓。如果只有一個 worker 的話，queue 的部分也可以簡單做一下，這邊我就也用 MySQL 來實做簡單的 queue，讓整個爬蟲的架構變得很簡單。</p>
<p>我們可以來看一下資料庫的架構：</p>
<h3 id="Users"><a href="#Users" class="headerlink" title="Users"></a>Users</h3><table>
<thead>
<tr>
<th>id</th>
<th>userId</th>
<th>username</th>
<th>name</th>
<th>bio</th>
<th>follower</th>
<th>fr</th>
<th>mediumMemberAt</th>
<th>createdAt</th>
</tr>
</thead>
<tbody><tr>
<td>自增ID</td>
<td>使用者 ID</td>
<td>前面加上 @ 就是 profile 網址</td>
<td>使用者名稱</td>
<td>自介</td>
<td>追蹤人數</td>
<td>分類</td>
<td>成為付費會員的時間</td>
<td>加入會員的時間</td>
</tr>
</tbody></table>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><table>
<thead>
<tr>
<th>id</th>
<th>userId</th>
</tr>
</thead>
<tbody><tr>
<td>自增ID</td>
<td>使用者 ID</td>
</tr>
</tbody></table>
<p>程式的執行流程是這樣的：</p>
<ol>
<li>從 Queue 裡面拿出一個 userId</li>
<li>如果 userId 已存在 Users，回到步驟一</li>
<li>把他的資料寫進 Users</li>
<li>把他的所有 follower 丟進 Queue</li>
<li>回到步驟一</li>
</ol>
<p>從 queue 拿出來的時候先確保沒有爬過這個使用者，有的話就跳過，然後把所有追蹤者再丟到 queue 裡面，這樣程式就會一直跑，直到 queue 裡面沒有東西為止。</p>
<p>架構設計好之後，就可以來開始 coding 啦！</p>
<h2 id="第一版爬蟲"><a href="#第一版爬蟲" class="headerlink" title="第一版爬蟲"></a>第一版爬蟲</h2><p>首先我們需要有一個 queue，能夠 push 跟 pop，還要能確定現在拿的 userId 是不是已經爬過了。這個很適合用 class 來實作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">conn</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">conn</span> = conn</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">&#x27;SELECT userId from Queues limit 1&#x27;</span>, <span class="function">(<span class="params">error, results</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">reject</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (results.<span class="property">length</span> !== <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="literal">null</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> data = results[<span class="number">0</span>]</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">&#x27;DELETE from Queues where userId=?&#x27;</span>, [data.<span class="property">userId</span>], <span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">reject</span>(error)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">resolve</span>(data.<span class="property">userId</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">check</span>(<span class="params">uid</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">&#x27;SELECT userId from Users where userId=?&#x27;</span>, [uid], <span class="keyword">function</span> (<span class="params">error, results</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">reject</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (results.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(<span class="literal">true</span>)</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">push</span>(<span class="params">list</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> values = []</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> list) &#123;</span><br><span class="line">        values.<span class="title function_">push</span>([item])</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        INSERT IGNORE INTO Queues (userId) VALUES ?`</span>, [values], <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="comment">// console.log(err)</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了 queue 以後可以來寫主要邏輯，主程式的架構會長這樣：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> connection = mysql.<span class="title function_">createPool</span>(&#123;</span><br><span class="line">  connectionLimit : <span class="number">10</span>,</span><br><span class="line">  host     : process.<span class="property">env</span>.<span class="property">host</span>,</span><br><span class="line">  user     : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  password : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  database : <span class="string">&#x27;medium&#x27;</span>,</span><br><span class="line">  <span class="attr">charset</span>: <span class="string">&#x27;utf8mb4&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> queue = <span class="keyword">new</span> <span class="title class_">Queue</span>(connection)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 不斷從 queue 拿東西出來</span></span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> userId = <span class="keyword">await</span> queue.<span class="title function_">get</span>()</span><br><span class="line">    <span class="keyword">if</span> (!userId) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;no data from queue, end&#x27;</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 看看是否已經爬過，爬過就跳掉</span></span><br><span class="line">    <span class="keyword">const</span> check = <span class="keyword">await</span> queue.<span class="title function_">check</span>(userId)</span><br><span class="line">    <span class="keyword">if</span> (!check) &#123;</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 拿 userId 做你想做的事</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;uid:&#x27;</span>, userId)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著只要實作以下兩個功能就好：</p>
<ol>
<li>抓取使用者資料</li>
<li>把使用者資料寫進資料庫</li>
<li>把 follower 丟回 queue</li>
</ol>
<p>由於 Medium API 的 response 都會有一個防 <a target="_blank" rel="noopener" href="https://medium.com/@jaydenlin/%E7%82%BA%E4%BD%95-facebook-api-%E8%A6%81%E5%9B%9E%E5%82%B3%E7%84%A1%E7%AA%AE%E8%BF%B4%E5%9C%88-%E8%AB%87%E6%8D%B2%E5%9C%9F%E9%87%8D%E4%BE%86%E7%9A%84-json-hijacking-bc220617ceba">json hijacking</a> 的開頭，因此我們可以包裝一個函式專門來 parse API 的 response：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getMediumResponse</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> axios.<span class="title function_">get</span>(url)</span><br><span class="line">    <span class="keyword">const</span> json = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(response.<span class="property">data</span>.<span class="title function_">replace</span>(<span class="string">&#x27;])&#125;while(1);&lt;/x&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> json</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接著就可以寫兩個 function，一個抓使用者資料，一個抓 follower 資料（有出現 _ 的都是 lodash 的 function）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getUserInfo</span>(<span class="params">uid</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="string">`https://medium.com/_/api/users/<span class="subst">$&#123;uid&#125;</span>/profile/stream`</span></span><br><span class="line">  <span class="keyword">const</span> json = <span class="keyword">await</span> <span class="title function_">getMediumResponse</span>(url)</span><br><span class="line">  <span class="keyword">if</span> (!json) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> userId = _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.userId&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> follower = _.<span class="title function_">get</span>(json, <span class="string">`payload.references.SocialStats.<span class="subst">$&#123;userId&#125;</span>.usersFollowedByCount`</span>, <span class="number">0</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">followerCount</span>: follower,</span><br><span class="line">    <span class="attr">userId</span>: userId,</span><br><span class="line">    <span class="attr">name</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.name&#x27;</span>),</span><br><span class="line">    <span class="attr">username</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.username&#x27;</span>),</span><br><span class="line">    <span class="attr">bio</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.bio&#x27;</span>),</span><br><span class="line">    <span class="attr">mediumMemberAt</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.mediumMemberAt&#x27;</span>),</span><br><span class="line">    <span class="attr">isWriterProgramEnrolled</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.isWriterProgramEnrolled&#x27;</span>),</span><br><span class="line">    <span class="attr">createdAt</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.createdAt&#x27;</span>),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getFollowers</span>(<span class="params">uid, to</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> url = <span class="string">`https://medium.com/_/api/users/<span class="subst">$&#123;uid&#125;</span>/profile/stream?source=followers&amp;limit=200`</span></span><br><span class="line">  <span class="keyword">if</span> (to) &#123;</span><br><span class="line">    url += <span class="string">&#x27;&amp;to=&#x27;</span> + to</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> json = <span class="keyword">await</span> <span class="title function_">getMediumResponse</span>(url)</span><br><span class="line">  <span class="keyword">if</span> (!json) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> followers = _.<span class="title function_">keys</span>(json.<span class="property">payload</span>.<span class="property">references</span>.<span class="property">Social</span>) || []</span><br><span class="line">  <span class="keyword">const</span> nextTo = _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.paging.next.to&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    followers,</span><br><span class="line">    nextTo</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基本上都是 call API 之後稍微處理一下資料，然後把我們關注的東西傳回去。</p>
<p>上面我們只實做了「抓一次 follower」的 function，所以最後還要再實作一個「抓全部 follower 並且丟進 queue」的 function：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAllFollowers</span>(<span class="params">uid, queue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> followers = []</span><br><span class="line">  <span class="keyword">let</span> to = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">getFollowers</span>(uid, to)</span><br><span class="line">    <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    followers.<span class="title function_">push</span>(...data.<span class="property">followers</span>)</span><br><span class="line">    to = data.<span class="property">nextTo</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(uid, <span class="string">&#x27;fetching...&#x27;</span>, followers.<span class="property">length</span>)</span><br><span class="line">    <span class="keyword">if</span> (data.<span class="property">followers</span>.<span class="property">length</span> === <span class="number">0</span> || !to) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> queue.<span class="title function_">push</span>(data.<span class="property">followers</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> followers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個函式會不斷去抓 follower 出來並丟進 queue，並且印出現在總共抓了幾筆 follower 的資料，全部抓完會把所有的 follower 回傳回去（會回傳是因為一開始我是全部抓完才一次寫進 queue，但後來發現比較沒效率，所以改成現在這樣抓一次就寫一次）。</p>
<p>最後是把使用者資料寫進去資料庫的程式碼：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">format</span>(<span class="params">time</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!time) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">moment</span>(time).<span class="title function_">format</span>(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">saveUserInfo</span>(<span class="params">conn, info</span>) &#123;</span><br><span class="line">  conn.<span class="title function_">query</span>(<span class="string">`</span></span><br><span class="line"><span class="string">    INSERT INTO Users</span></span><br><span class="line"><span class="string">    (</span></span><br><span class="line"><span class="string">      userId, username, name, bio, follower,</span></span><br><span class="line"><span class="string">      mediumMemberAt, createdAt, isWriterProgramEnrolled</span></span><br><span class="line"><span class="string">    ) VALUES ?`</span>, [[[</span><br><span class="line">      info.<span class="property">userId</span>, info.<span class="property">username</span>, info.<span class="property">name</span>, info.<span class="property">bio</span>, info.<span class="property">followerCount</span>,</span><br><span class="line">      <span class="title function_">format</span>(info.<span class="property">mediumMemberAt</span>), <span class="title function_">format</span>(info.<span class="property">createdAt</span>), info.<span class="property">isWriterProgramEnrolled</span></span><br><span class="line">    ]]], <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">// console.log(err)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把這幾個核心功能的 function 寫完以後，只要修正一下我們的主程式，就可以把整個爬蟲完成了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> queue = <span class="keyword">new</span> <span class="title class_">Queue</span>(connection)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. 從 Queue 裡面拿出一個 userId</span></span><br><span class="line">    <span class="keyword">const</span> userId = <span class="keyword">await</span> queue.<span class="title function_">get</span>()</span><br><span class="line">    <span class="keyword">if</span> (!userId) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;no data from queue, end&#x27;</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 如果 userId 已存在 Users，回到步驟一</span></span><br><span class="line">    <span class="keyword">const</span> check = <span class="keyword">await</span> queue.<span class="title function_">check</span>(userId)</span><br><span class="line">    <span class="keyword">if</span> (!check) &#123;</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;uid:&#x27;</span>, userId)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> info = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(userId)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 如果沒抓到資料有可能是被擋了，先停個 3 秒</span></span><br><span class="line">      <span class="keyword">if</span> (!info.<span class="property">userId</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;sleep...&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">3000</span>)</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 3. 把他的資料寫進 Users</span></span><br><span class="line">      <span class="title function_">saveUserInfo</span>(connection, info)</span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 4. 把他的所有 follower 丟進 Queue</span></span><br><span class="line">      <span class="keyword">if</span> (info.<span class="property">followerCount</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 把 followers 放到 queue 並印出總共幾筆資料</span></span><br><span class="line">        <span class="keyword">const</span> followerList = <span class="keyword">await</span> <span class="title function_">getAllFollowers</span>(userId, queue)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Add &#x27;</span> + followerList.<span class="property">length</span> + <span class="string">&#x27; into queue.&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">      <span class="comment">// 有錯誤就先睡個 3 秒</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error...sleep&#x27;</span>)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">sleep</span>(<span class="number">3000</span>)</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面就是我們按照先前的邏輯寫出來的程式碼：</p>
<ol>
<li>從 Queue 裡面拿出一個 userId</li>
<li>如果 userId 已存在 Users，回到步驟一</li>
<li>把他的資料寫進 Users</li>
<li>把他的所有 follower 丟進 Queue</li>
<li>回到步驟一</li>
</ol>
<p>不過這邊額外加了一個邏輯是當呼叫 API 有問題的時候，就先暫停 3 秒鐘，這樣是為了防止被 rate limiting 擋到。但這個機制做的不是很好，因為沒有 retry，所以一但發生錯誤，這個 userId 就被跳過了。</p>
<p>當初的想法是只跳過一個 userId 無傷大雅，畢竟 queue 裡面可能有十萬筆的 userId，而且就算跳過，之後還是有可能再被丟到 queue 裡面，所以不做 retry 的機制也無所謂。</p>
<p>上面的程式碼全部組裝起來，就是第一版爬蟲的雛形了。運作的 ok 沒什麼問題，就只是速度比較慢而已。而且 queue 增長的速度比想像中驚人，我跑了一個晚上 queue 大概就多了十萬筆資料，而 users 裡面卻只有四五千筆而已。</p>
<p>不過在跑了一個晚上之後，我發現了一個致命的錯誤。</p>
<h2 id="第二版爬蟲：判斷中文"><a href="#第二版爬蟲：判斷中文" class="headerlink" title="第二版爬蟲：判斷中文"></a>第二版爬蟲：判斷中文</h2><p>這個致命的錯誤就是當初的預設：「中文作者的 follower 都是中文作者」是有問題的，而且仔細想想會發現這個預設的確很不可靠。</p>
<p>所以跑了一個晚上的爬蟲，我發現資料庫裡面多了一大堆外國使用者。而且一但多了一個，你的 queue 裡面就會出現一大堆的外國使用者。</p>
<p>為了避免這個情形，我決定從自介跟暱稱下手，寫一個判斷自介跟暱稱是否含有中文的函式，如果有中文才被放進來。這邊我直接複製在 Stack Overflow 上找到的程式碼，看起來十分神奇：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isChinese</span>(<span class="params">text = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">  <span class="comment">// @see: https://stackoverflow.com/questions/44669073/regular-expression-to-match-and-split-on-chinese-comma-in-javascript/51941287#51941287</span></span><br><span class="line">  <span class="keyword">const</span> regex = <span class="regexp">/(\p&#123;Script=Hani&#125;)+/gu</span>;</span><br><span class="line">  <span class="keyword">return</span> text.<span class="title function_">match</span>(regex)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 queue 裡面抓完使用者資料後會進行判斷：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> info = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(userId)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 非中文，直接略過</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_">isChinese</span>(info.<span class="property">bio</span>) &amp;&amp; !<span class="title function_">isChinese</span>(info.<span class="property">name</span>)) &#123;</span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做這個判斷的時候我就已經想到會有一個問題，那就是有些人他們喜歡國際化一點，在自介會放全英文，暱稱也會是英文，所以會被誤判。明明就是用中文寫作，但是卻沒有被加進 queue 裡面。</p>
<p>這邊我當時覺得無所謂，畢竟這樣的人不多，而且要解的話有點麻煩。當時我腦中本來就有浮現一個解法，就是去抓他最近拍手過或發表過的文章，看看標題是不是中文，這樣的判斷會準確很多。但當時我懶得實作，想說先讓爬蟲繼續跑一天看看。</p>
<p>隔天早上，又發現了一個完全沒想過會碰到的問題。</p>
<h2 id="第三版爬蟲：判斷日文"><a href="#第三版爬蟲：判斷日文" class="headerlink" title="第三版爬蟲：判斷日文"></a>第三版爬蟲：判斷日文</h2><p>使用者清單裡面出現一大堆日本人。</p>
<p>因為他們有些暱稱是漢字，要嘛就是自介有漢字，所以不會被中文判斷篩掉。發現這個問題的時候我第一個想法是：「如果這是在面試我一定被刷掉，這種 case 居然當初沒想到…」。</p>
<p>為了解決這種情況，就再找了一個判斷是不是有日文（不含漢字）的正則表達式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">isJapanese</span>(<span class="params">text = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">  <span class="comment">// @see: https://gist.github.com/ryanmcgrath/982242</span></span><br><span class="line">  <span class="keyword">const</span> regexJP = <span class="regexp">/[\u3040-\u309F]|[\u30A0-\u30FF]/g</span>; </span><br><span class="line">  <span class="keyword">const</span> jp = text.<span class="title function_">match</span>(regexJP)</span><br><span class="line">  <span class="keyword">if</span> (jp &amp;&amp; jp.<span class="property">length</span> &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果含有三個以上的日文字母，就回傳是日文。這邊會設定數量是我怕有些台灣人用什麼 <code>の</code> 之類的，就會被誤判。不過除了寫死數量以外，還有個比較好的做法可能是看比例，例如說一句話如果有八九成是中文字，就是中文之類的。</p>
<p>判斷邏輯的部分改成這樣：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> info = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(userId)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 非中文，直接略過</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_">isChinese</span>(info.<span class="property">bio</span>) &amp;&amp; !<span class="title function_">isChinese</span>(info.<span class="property">name</span>)) &#123;</span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isJapanese</span>(info.<span class="property">bio</span>) || <span class="title function_">isJapanese</span>(info.<span class="property">name</span>)) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不是中文就跳過，再來確認是不是日文，如果自介或是暱稱是日文也跳過。</p>
<p>好，這樣就沒有問題了吧！於是我把資料砍光，再讓爬蟲跑一個晚上試試看。</p>
<p>隔天起來，發現我真是天真的可以。</p>
<h2 id="第四版爬蟲：直接重構"><a href="#第四版爬蟲：直接重構" class="headerlink" title="第四版爬蟲：直接重構"></a>第四版爬蟲：直接重構</h2><p>打開資料庫，發現還是有很多日本使用者。原因在於他們可能暱稱是用漢字，然後沒有寫自介，或者自介只有一兩個字之類的，所以還是會被判定為是中文使用者。</p>
<p>追根究底，都是這個判斷機制太不可靠的原因。</p>
<p>既然事情已經到這個地步，就沒辦法偷懶了，我只能實作剛開始提到的更準確的解法：「看看最近發表過或是拍手過的文章是不是中文」，而這部分的資料幸好原本的 API 就有提供，實作起來比想像中簡單許多。</p>
<p>除了這個以外，由於 queue 增長的速度比消耗的速度快太多，因此我一度改變了一下方法。我寫了另外一支小程式，把原本流程中的「把 followers 丟到 queue」拿掉，並且一次拿 10 筆使用者資料出來。</p>
<p>換句話說，這個新的小程式做的事情很簡單，就是不斷抓使用者資料並存到資料庫，這樣 queue 就會一直變小，讓使用者資料愈來愈多。大概一個小時可以抓兩萬筆，累積一個晚上的 queue 白天花半天就可以跑完。</p>
<p>好處就是我可以快速累積使用者資料，畢竟原本的實作太慢了，一天大概只能跑個一萬筆左右，現在新的實作因為不用把東西丟到 queue 裡面，會讓使用者資料長得很快。</p>
<p>那時候偷懶直接複製程式碼改一下就做完這個新的小程式，導致程式寫到這邊愈來愈亂，考量到之後想要 open source，是時候整理一下程式碼了，於是就順便把程式重構一下。</p>
<p>重構完的架構如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md     // 說明</span><br><span class="line">├── app.js        // 主程式</span><br><span class="line">├── getUsers.js   // 只抓使用者資料的小程式 </span><br><span class="line">├── config.js     // 設定檔</span><br><span class="line">├── db.js         // 資料庫相關</span><br><span class="line">├── medium.js     // medium API 相關</span><br><span class="line">├── package.json  </span><br><span class="line">├── queue.js     </span><br><span class="line">└── utils.js       </span><br></pre></td></tr></table></figure>

<p>我們先從 config 開始看起吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">db</span>: &#123;</span><br><span class="line">    <span class="attr">connectionLimit</span>: <span class="number">10</span>,</span><br><span class="line">    host     : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    user     : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    password : <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    database : <span class="string">&#x27;medium&#x27;</span>,</span><br><span class="line">    <span class="attr">charset</span>: <span class="string">&#x27;utf8mb4&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">batchLimit</span>: <span class="number">1</span>, <span class="comment">// 一次抓多少筆使用者資料</span></span><br><span class="line">  <span class="attr">randomDelay</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">200</span>) + <span class="number">100</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">errorRateTolerance</span>: <span class="number">0.2</span>,</span><br><span class="line">  <span class="attr">delayWhenError</span>: <span class="number">500</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊就是放一些設定檔，包括資料庫的設定以及一些抓資料的參數，大多數都是跟抓使用者資料的那個小程式有關，例如說要抓幾筆，然後每一次要停多久之類的。這些都是為了避免送太多 request 被擋而做的措施。</p>
<p>再來看一下 utils.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// @see: https://stackoverflow.com/questions/44669073/regular-expression-to-match-and-split-on-chinese-comma-in-javascript/51941287#51941287</span></span><br><span class="line">  <span class="attr">isChinese</span>: <span class="function">(<span class="params">text = <span class="string">&#x27;&#x27;</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> regex = <span class="regexp">/(\p&#123;Script=Hani&#125;)+/gu</span>;</span><br><span class="line">    <span class="keyword">return</span> text.<span class="title function_">match</span>(regex)</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// @see: https://gist.github.com/ryanmcgrath/982242</span></span><br><span class="line">  <span class="attr">isJapanese</span>: <span class="function">(<span class="params">text = <span class="string">&#x27;&#x27;</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> regexJP = <span class="regexp">/[\u3040-\u309F]|[\u30A0-\u30FF]/g</span>; </span><br><span class="line">    <span class="keyword">const</span> jp = text.<span class="title function_">match</span>(regexJP)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// more than 2 japanese char</span></span><br><span class="line">    <span class="keyword">if</span> (jp &amp;&amp; jp.<span class="property">length</span> &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">sleep</span>: <span class="function"><span class="params">ms</span> =&gt;</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(resolve, ms)</span><br><span class="line">  &#125;),</span><br><span class="line">  </span><br><span class="line">  <span class="attr">log</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> args = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="property">log</span>.<span class="title function_">apply</span>(<span class="variable language_">console</span>, args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊基本上就是把剛剛用到的一些函式搬過來統一放在這邊，日文字母的限制縮小為兩個，然後把 console.log 包裝了一下，想說之後要客製化比較方便。</p>
<p>然後是 medium.js，這邊是有關 medium API 的部分，並且新增了一個函式 <code>isMandarinUser</code> 來判斷是否是中文使用者：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">JSON</span>_HIJACKING_PREFIX = <span class="string">&#x27;])&#125;while(1);&lt;/x&gt;&#x27;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// wrapper function, return null instead of throwing error</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getMediumResponse</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> axios.<span class="title function_">get</span>(url)</span><br><span class="line">    <span class="keyword">const</span> json = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(response.<span class="property">data</span>.<span class="title function_">replace</span>(<span class="title class_">JSON</span>_HIJACKING_PREFIX, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> json</span><br><span class="line">  &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isMandarinUser</span>(<span class="params">name, bio, posts</span>) &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// if bio or name is japanese, must be japanese</span></span><br><span class="line">  <span class="keyword">if</span> (utils.<span class="title function_">isJapanese</span>(name) || utils.<span class="title function_">isJapanese</span>(bio)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// this user has no activity on medium, decide by name and bio</span></span><br><span class="line">  <span class="keyword">if</span> (!posts) &#123;</span><br><span class="line">    <span class="keyword">return</span> utils.<span class="title function_">isChinese</span>(name) || utils.<span class="title function_">isChinese</span>(bio)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> contents = _.<span class="title function_">values</span>(posts).<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">title</span> + _.<span class="title function_">get</span>(item, <span class="string">&#x27;content.subtitle&#x27;</span>))</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Boolean</span>(</span><br><span class="line">    contents.<span class="title function_">find</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> utils.<span class="title function_">isChinese</span>(item) &amp;&amp; !utils.<span class="title function_">isJapanese</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">getFollowers</span>: <span class="title function_">async</span> (uid, to) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="string">`https://medium.com/_/api/users/<span class="subst">$&#123;uid&#125;</span>/profile/stream?source=followers&amp;limit=200`</span></span><br><span class="line">    <span class="keyword">if</span> (to) &#123;</span><br><span class="line">      url += <span class="string">&#x27;&amp;to=&#x27;</span> + to</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> json = <span class="keyword">await</span> <span class="title function_">getMediumResponse</span>(url)</span><br><span class="line">    <span class="keyword">if</span> (!json) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> followers = _.<span class="title function_">keys</span>(json.<span class="property">payload</span>.<span class="property">references</span>.<span class="property">Social</span>) || []</span><br><span class="line">    <span class="keyword">const</span> nextTo = _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.paging.next.to&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      followers,</span><br><span class="line">      nextTo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="attr">getUserInfo</span>: <span class="title function_">async</span> (uid) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">`https://medium.com/_/api/users/<span class="subst">$&#123;uid&#125;</span>/profile/stream`</span></span><br><span class="line">    <span class="keyword">const</span> json = <span class="keyword">await</span> <span class="title function_">getMediumResponse</span>(url)</span><br><span class="line">    <span class="keyword">if</span> (!json) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> userId = _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.userId&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> follower = _.<span class="title function_">get</span>(json, <span class="string">`payload.references.SocialStats.<span class="subst">$&#123;userId&#125;</span>.usersFollowedByCount`</span>, <span class="number">0</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> posts = _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.references.Post&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> name = _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.name&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> bio = _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.bio&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">isMandarinUser</span>: <span class="title function_">isMandarinUser</span>(name, bio, posts),</span><br><span class="line">      userId,</span><br><span class="line">      name,</span><br><span class="line">      <span class="attr">username</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.username&#x27;</span>),</span><br><span class="line">      bio,</span><br><span class="line">      <span class="attr">followerCount</span>: follower,</span><br><span class="line">      <span class="attr">mediumMemberAt</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.mediumMemberAt&#x27;</span>),</span><br><span class="line">      <span class="attr">isWriterProgramEnrolled</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.isWriterProgramEnrolled&#x27;</span>),</span><br><span class="line">      <span class="attr">createdAt</span>: _.<span class="title function_">get</span>(json, <span class="string">&#x27;payload.user.createdAt&#x27;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>isMandarinUser 會根據三個參數來決定：暱稱、自介以及相關文章。相關文章可能是使用者最近發表過的或者是回覆過與拍手過的文章，會根據文章的標題以及副標題來做判定。</p>
<p>如果使用者沒有任何活動的話，就會跟之前一樣採用自介跟暱稱來判定，所以還是有誤判的可能，但實測過後誤判率已經滿低的了。</p>
<p>接著來看與資料庫相關的操作，db.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mysql = <span class="built_in">require</span>(<span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">format</span>(<span class="params">time</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!time) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">moment</span>(time).<span class="title function_">format</span>(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">transform</span>(<span class="params">info</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    info.<span class="property">userId</span>, info.<span class="property">username</span>, info.<span class="property">name</span>, info.<span class="property">bio</span>, info.<span class="property">followerCount</span>,</span><br><span class="line">    <span class="title function_">format</span>(info.<span class="property">mediumMemberAt</span>), <span class="title function_">format</span>(info.<span class="property">createdAt</span>), info.<span class="property">isWriterProgramEnrolled</span>, <span class="literal">null</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DB</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">config</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">conn</span> = mysql.<span class="title function_">createPool</span>(config)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">getExistingUserIds</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">&#x27;SELECT userId from Users&#x27;</span>, <span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">reject</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">resolve</span>(results.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">userId</span>))</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="title function_">getUserIds</span>(<span class="params">limit</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">&#x27;SELECT userId from Users where fr=&quot;TW&quot; order by follower desc limit &#x27;</span> + limit, <span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">reject</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">resolve</span>(results.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">userId</span>))</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="title function_">deleteUserIds</span>(<span class="params">userIds</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">&#x27;DELETE from Queues WHERE userId IN (?)&#x27;</span>, [userIds], <span class="function">(<span class="params">err, results</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">reject</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(userIds)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">insertUserData</span>(<span class="params">info</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!info) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(info) ? info.<span class="title function_">map</span>(transform) : [<span class="title function_">transform</span>(info)]</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">`</span></span><br><span class="line"><span class="string">      INSERT INTO Users</span></span><br><span class="line"><span class="string">      (</span></span><br><span class="line"><span class="string">        userId, username, name, bio, follower,</span></span><br><span class="line"><span class="string">        mediumMemberAt, createdAt, isWriterProgramEnrolled, fr</span></span><br><span class="line"><span class="string">      ) VALUES ?`</span>, [data], <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="comment">// console.log(err)</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">insertIntoQueue</span>(<span class="params">list</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> values = []</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> list) &#123;</span><br><span class="line">        values.<span class="title function_">push</span>([item])</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">conn</span>.<span class="title function_">query</span>(<span class="string">`</span></span><br><span class="line"><span class="string">        INSERT IGNORE INTO Queues (userId) VALUES ?`</span>, [values], <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="comment">// console.log(err)</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="variable constant_">DB</span></span><br></pre></td></tr></table></figure>

<p>基本上就是把一大堆 SQL query 包裝成 Promise 以及 function，方便其他的 module 來使用。大部分的函式都能夠接收一個 array 來做批次操作，這樣會更有效率一點。</p>
<p>而且把這些東西包裝起來之後，queue 的程式碼就會變得非常單純：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">db</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">db</span> = db</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">get</span>(<span class="params">limit</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> items = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">db</span>.<span class="title function_">getUserIds</span>(limit)</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">db</span>.<span class="title function_">deleteUserIds</span>(items)</span><br><span class="line">    <span class="keyword">return</span> items</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">push</span>(<span class="params">list</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">db</span>.<span class="title function_">insertIntoQueue</span>(list)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Queue</span></span><br></pre></td></tr></table></figure>

<p>最後來看一下我們的主程式 app.js，在重構之後程式碼變得乾淨很多，可讀性也提昇了不少：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">DB</span> = <span class="built_in">require</span>(<span class="string">&#x27;./db&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Queue</span> = <span class="built_in">require</span>(<span class="string">&#x27;./queue&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> medium = <span class="built_in">require</span>(<span class="string">&#x27;./medium&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">new</span> <span class="title function_">DB</span>(config.<span class="property">db</span>)</span><br><span class="line">  <span class="keyword">const</span> queue = <span class="keyword">new</span> <span class="title class_">Queue</span>(db)</span><br><span class="line">  <span class="keyword">const</span> existingUserIds = <span class="keyword">await</span> db.<span class="title function_">getExistingUserIds</span>()</span><br><span class="line">  <span class="keyword">const</span> userIdMap = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> userId <span class="keyword">of</span> existingUserIds) &#123;</span><br><span class="line">    userIdMap[userId] = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  utils.<span class="title function_">log</span>(<span class="string">&#x27;Existing userId:&#x27;</span>, existingUserIds.<span class="property">length</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> userIds = <span class="keyword">await</span> queue.<span class="title function_">get</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> (userIds.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      utils.<span class="title function_">log</span>(<span class="string">&#x27;Done&#x27;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">const</span> userId = userIds[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (userIdMap[userId]) &#123;</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    userIdMap[userId] = <span class="literal">true</span></span><br><span class="line">    utils.<span class="title function_">log</span>(<span class="string">&#x27;userId:&#x27;</span>, userId)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> userInfo = <span class="keyword">await</span> medium.<span class="title function_">getUserInfo</span>(userId)</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (!userInfo.<span class="property">userId</span>) &#123;</span><br><span class="line">        utils.<span class="title function_">log</span>(<span class="string">&#x27;getUerrInfo error, sleep for&#x27;</span>, config.<span class="property">delayWhenError</span>)</span><br><span class="line">        <span class="keyword">await</span> utils.<span class="title function_">sleep</span>(config.<span class="property">delayWhenError</span>)</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (!userInfo.<span class="property">isMandarinUser</span>) &#123;</span><br><span class="line">        utils.<span class="title function_">log</span>(userId, <span class="string">&#x27;not MandarinUser&#x27;</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      db.<span class="title function_">insertUserData</span>(userInfo)</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (userInfo.<span class="property">followerCount</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> to = <span class="literal">undefined</span></span><br><span class="line">        <span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> data = <span class="keyword">await</span> medium.<span class="title function_">getFollowers</span>(userInfo.<span class="property">userId</span>, to)</span><br><span class="line">          <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">const</span> &#123; nextTo, followers &#125; = data</span><br><span class="line">          to = nextTo</span><br><span class="line">          count += followers.<span class="property">length</span></span><br><span class="line">          utils.<span class="title function_">log</span>(userInfo.<span class="property">userId</span>, <span class="string">&#x27;fetching&#x27;</span>, count, <span class="string">&#x27;followers&#x27;</span>)</span><br><span class="line">          <span class="keyword">await</span> queue.<span class="title function_">push</span>(followers.<span class="title function_">filter</span>(<span class="function"><span class="params">uid</span> =&gt;</span> !userIdMap[uid]))</span><br><span class="line">          <span class="keyword">if</span> (followers.<span class="property">length</span> === <span class="number">0</span> || !to) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      utils.<span class="title function_">log</span>(<span class="string">&#x27;sleep for&#x27;</span>, config.<span class="property">delayWhenError</span>)</span><br><span class="line">      utils.<span class="title function_">log</span>(err)</span><br><span class="line">      <span class="keyword">await</span> utils.<span class="title function_">sleep</span>(config.<span class="property">delayWhenError</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  process.<span class="title function_">exit</span>()</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="title function_">main</span>()</span><br></pre></td></tr></table></figure>

<p>這邊有個機制與之前不一樣，之前是每次從 queue 拿一個 userId 出來就去資料庫確認一下是否爬過，但是這樣太沒有效率。在這個版本改成程式執行時就直接從資料庫裡面把所有資料拿出來，並且變成一個 map，如果有值的話就代表已經抓取過，反之亦然。</p>
<p>重構過的程式碼把 module 切開之後看起來順眼很多，而且要改什麼都很容易，沒有重構過的話我還真不敢 open source 出去…</p>
<p>這邊是重構完的程式碼：<a target="_blank" rel="noopener" href="https://github.com/aszx87410/medium-user-crawler">https://github.com/aszx87410/medium-user-crawler</a></p>
<h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><p>在寫爬蟲的過程中也是踩了滿多坑的，其中最麻煩的就是語言判斷那一塊，當初沒有想到日文漢字這個 case 要判斷，花了不少時間。偷懶也花了很多時間，原本偷懶不想用更精確的方法來做判定，沒想到最後還是得用，中間浪費了不少時間。</p>
<p>這爬蟲還有滿多地方可以改進的，例如說執行速度的部分，或者是判定語言的部分，目前是我把資料撈出來之後手動標是香港、台灣還是中國，但或許可以寫一些小程式來自動判定，例如說簡體就是中國，有出現一些粵語的字就是香港，反之則是台灣等等，雖然不一定準確，但至少用程式來輔助會方便很多。</p>
<p>這篇主要是分享一下我寫這個爬蟲的歷程，其實只要資料來源能確定抓得到，其他都不是什麼大問題。再加上這個爬蟲沒有很完整（例如說沒有 retry 機制），所以花個一兩天就能夠實作完成了。</p>
<p>希望這篇有吸引到大家，也很希望大家能試試看自己爬資料，做出有趣的數據分析！</p>
<p>關於作者：<br><a target="_blank" rel="noopener" href="https://medium.com/@hulitw">@huli</a> 野生工程師，相信分享與交流能讓世界變得更美好</p>
  
      <div>喜歡我們的文章嗎？歡迎分享按讚給予我們支持和鼓勵！</div>
      <div class="fb-like" data-href="https://blog.techbridge.cc/2019/07/13/medium-crawler/index.html" data-layout="button_count" data-action="like" data-size="large" data-show-faces="false" data-share="true"></div>
      <br>
      <br>
      <div class="fb-page" data-href="https://www.facebook.com/techbridge.cc" data-small-header="false" data-adapt-container-width="true" data-hide-cover="false" data-show-facepile="true"><blockquote cite="https://www.facebook.com/techbridge.cc" class="fb-xfbml-parse-ignore"><a target="_blank" rel="noopener" href="https://www.facebook.com/techbridge.cc">TechBridge 技術日報</a></blockquote></div>
      <br>
    </section>
    <br>
    <hr>
    <div>
      <h4>訂閱 TechBridge Weekly 技術週刊，每週發送最精華的技術開發、產品設計的資訊給您</h4>
      <form class="form-control" method="post" action="https://goodbits.io/e/cab8a418-6b70-48d6-97ea-b5f0ef34b22c" target="_blank">
        <input class="form-control" type="text" name="first_name" placeholder="First Name"></input>
        <input class="form-control" type="text" name="last_name" placeholder="Last Name"></input>
        <div>
          <input class="form-control" type="text" name="email" placeholder="Email"></input>
        </div>
        <br>
        <div>
          <button class="form-control btn subscribe-btn" type="submit">馬上訂閱技術週刊</button>
        </div>
        <br>
        <label for="">PS. 我們討厭垃圾信，所以我們只提供有價值的內容給您 :)</label>
      </form>
    </div>
    <footer class="post-footer">
      <section class="author">
    <h4>TechBridge Weekly 技術週刊編輯團隊</h4>
    <p>TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、資料科學與產品設計等技術分享。This is TechBridge Weekly Team Tech Blog, which focus on web, mobile, robotics, IoT, Data Science technology sharing.</p>
    <span><a href="/2016/03/19/about/">關於我們</a></span> / <span><a href="https://www.techbridge.cc/" target="_blank">技術日報</a></span> / <span><a href="http://weekly.techbridge.cc/" target="_blank">技術週刊</a></span> / <span><a href="https://www.facebook.com/techbridge.cc/" target="_blank">粉絲專頁</a></span> / <span><a href="/atom.xml" target="_blank">訂閱RSS </a></span>   
	<div class="fb-like" data-href="https://www.facebook.com/techbridge.cc" data-layout="button_count" data-size="large" data-action="like" data-show-faces="false" data-share="true"></div>    
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" target="_blank" rel="noopener" href="http://twitter.com/share?url=https://blog.techbridge.cc/2019/07/13/medium-crawler/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" target="_blank" rel="noopener" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.techbridge.cc/2019/07/13/medium-crawler/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" target="_blank" rel="noopener" href="https://plus.google.com/share?url=https://blog.techbridge.cc/2019/07/13/medium-crawler/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
    <iframe src="https://ghbtns.com/github-btn.html?user=TechBridgeHQ&repo=blog-starter-kit&type=star&count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>      
</section>
    </footer>
    <br>
  </article>
  <nav class="pagination" role="pagination">
    <h2>更多優質技術文章</h2>
    
    <a class="newer-posts" href="/2019/07/16/web-ar/">
        ← 淺嚐 Web AR
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2019/07/05/zooz-2018-oa/">
        ZOOX 自動駕駛公司面試題目 →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">留言討論</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75308642-1', 'auto');
  ga('send', 'pageview');

</script>
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="/atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">TechBridge 技術共筆部落格</a> &copy; 2017 &bull; All rights reserved.</section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>


<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '[object Object]']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>


<script type="text/javascript">
    var disqus_shortname = 'techbridgeweekly';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.4/dist/medium-zoom.min.js"></script>
<script>
// NodeList
mediumZoom(document.querySelectorAll('img'));
</script>
  <div id="fb-root"></div>
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>
</body>
</html>
