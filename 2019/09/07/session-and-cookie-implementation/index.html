<!DOCTYPE html>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>深入 Session 與 Cookie：Express、PHP 與 Rails 的實作 | TechBridge 技術共筆部落格</title>
  <meta name="description" content="TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、數據分析與產品設計等技術分享">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- google-site-verification -->
  <meta name="google-site-verification" content="WX_9sZlrIYOEpy8RR7zCoa7-pJk611zZt11BSBUcDVY">
  <link rel="stylesheet preload" type="text/css" href="/css/screen.css" as="style">
  <link rel="stylesheet preload" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" as="style">

  <!-- Favicons -->
  <link rel="apple-touch-icon" href="/img/favicon.ico">
  <link rel="icon preload" href="/img/favicon.ico" as="image">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  
  

  
</head>


<body class="post-template">

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo-tb-500-500.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">TechBridge 技術共筆部落格</h1>
            <h2 class="blog-description">var topics = ['Web前後端', '行動網路', '機器人/物聯網', '數據分析', '產品設計', 'etc.']</h2>
            <div class="navbar-block">
                <span><a href="/">首頁</a></span> / <span><a href="/about/">關於我們</a></span> / <span><a href="http://weekly.techbridge.cc/" target="_blank">技術週刊</a></span> / <span><a href="https://www.facebook.com/techbridge.cc/" target="_blank">粉絲專頁</a></span> / <span><a href="/atom.xml" target="_blank">訂閱RSS </a></span>
                <br>
            </div>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2019-09-07T02:05:40.000Z" itemprop="datePublished">
          2019-09-07
      </time>
    
    
    | 
    <a href='/tags/web/'>web</a>,
    
    <a href='/tags/cookie/'>cookie</a>,
    
    <a href='/tags/session/'>session</a>
    
    
</span>

<meta name="generator" content="深入 Session 與 Cookie：Express、PHP 與 Rails 的實作">
<meta name="og:title" content="深入 Session 與 Cookie：Express、PHP 與 Rails 的實作">
<meta name="og:description" content="TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、數據分析與產品設計等技術分享。">
<meta name="og:type" content="website">
<meta name="og:image" content="/img/og-cover.png">

    <h1 class="post-title">深入 Session 與 Cookie：Express、PHP 與 Rails 的實作</h1>
    <section class="post-content">
      <div class="fb-like" data-href="https://www.facebook.com/techbridge.cc" data-layout="button_count" data-action="like" data-size="large" data-show-faces="false" data-share="true"></div>   
      <hr>
      <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>這是一系列共三篇的文章，我稱之為 Session 與 Cookie 三部曲。系列文的目標是想要由淺入深來談談這個經典議題，從理解概念一直到理解實作方式。這是系列文的最後一篇，三篇的完整連結如下：</p>
<ol>
<li><a href="https://medium.com/@hulitw/session-and-cookie-15e47ed838bc" target="_blank" rel="noopener">白話 Session 與 Cookie：從經營雜貨店開始</a></li>
<li><a href="https://github.com/aszx87410/blog/issues/45" target="_blank" rel="noopener">淺談 Session 與 Cookie：一起來讀 RFC</a></li>
<li><a href="https://github.com/aszx87410/blog/issues/46" target="_blank" rel="noopener">深入 Session 與 Cookie：Express、PHP 與 Rails 的實作
</a></li>
</ol>
<p>第一篇以白話的方式來談 Session 與 Cookie，全篇沒有談到太多技術名詞；第二篇直接去看 Cookie 的三份 RFC 來理解到底什麼是 Session，也補齊了一些 Cookie 相關的知識。而這一篇則是要深入 Session，一起帶大家看看三種不同的 Session 實作方式。</p>
<p>這三樣分別是 Node.js 的 Web 框架 Express、PHP 以及 Ruby on Rails。會挑選這三個是因為他們對於 Session 機制的實作都不同，是我覺得很適合拿來參考的對象。</p>
<p>好，接著就開始吧！</p>
<h2 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h2><p><a href="https://expressjs.com/" target="_blank" rel="noopener">Express</a> 本身是個極度輕量的框架，有許多其他框架底下的基本功能，在這邊都要額外安裝 middleware 才能使用。</p>
<p>先來簡單介紹一下 middleware 的概念。在 Express 裡面，當收到一個 Request  之後就會轉交給相對應的 middleware 來做處理，處理完以後變成 Response 回傳回去。所以 Express 的本質其實就是一大堆 middleware。</p>
<p>用圖解釋的話會長這樣：</p>
<p><img src="https://user-images.githubusercontent.com/2755720/62776748-10456480-bade-11e9-8000-6604aca08c8c.png" alt="螢幕快照 2019-08-08 下午11 22 26"></p>
<p>舉個例子好了，一段基本的程式碼會長這樣：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">5001</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// global 的 middleware</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  req.greeting = <span class="string">'hello'</span></span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 特定 route 的 middleware</span></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.end(req.greeting)</span><br><span class="line">&#125;)</span><br><span class="line">  </span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Example app listening on port <span class="subst">$&#123;port&#125;</span>!`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>第一個 middleware 是 global 的，所以任何 request 都會先到達這個 middleware，而這邊可以對 req 或是 res 這兩個參數設置一些東西，最後呼叫 <code>next</code> 把控制權轉給下一個 middleware。</p>
<p>而下一個 middleware 就可以拿到前面的 middleware 處理過後的資訊，並且輸出內容。如果沒有呼叫 next，代表不想把控制權轉移給下個 middleware。</p>
<p>在 Express 裡面，管理 Session 的 middleware 是 <a href="https://github.com/expressjs/session" target="_blank" rel="noopener">express-session</a>，範例程式碼長這樣（改寫自官網範例）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">5001</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// 使用 session middleware</span></span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  secret: <span class="string">'keyboard cat'</span></span><br><span class="line">&#125;))</span><br><span class="line">   </span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 可以用 req.session 拿取存在 session 的值</span></span><br><span class="line">  <span class="comment">// 這邊判斷有沒有 req.session.views</span></span><br><span class="line">  <span class="comment">// 如果有的話就 +1，反之初始化成 1</span></span><br><span class="line">  <span class="comment">// 所以 req.session 可讀也可寫</span></span><br><span class="line">  <span class="keyword">if</span> (req.session.views) &#123;</span><br><span class="line">    req.session.views++</span><br><span class="line">    res.write(<span class="string">'views: '</span> + req.session.views)</span><br><span class="line">    res.end()</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    req.session.views = <span class="number">1</span></span><br><span class="line">    res.end(<span class="string">'welcome to the session demo. refresh!'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">  </span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Example app listening on port <span class="subst">$&#123;port&#125;</span>!`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>使用了 session middleware 以後，可以直接用 <code>req.session.key</code> 來存取你要的資訊，同一個變數可以寫入也可以讀取，跟 PHP 的 $_SESSION 有異曲同工之妙。</p>
<p>接著我們來看看 express-session 的程式碼吧！主要的程式碼都在 <a href="https://github.com/expressjs/session/blob/master/index.js" target="_blank" rel="noopener">index.js</a> 這個檔案，大概有快七百行，不太可能一行一行講解。</p>
<p>而且寫得好的 library，會花很多精力在向後相容以及資料合法性的檢查，這些都是一些比較瑣碎而且對於想要理解機制比較沒幫助的東西。</p>
<p>所以我會直接把程式碼稍微整理一下，去除掉比較不重要的部分並且重新組織程式碼，只挑出相關的段落。</p>
<p>我們會關注三個重點：</p>
<ol>
<li>sessionID 如何產生</li>
<li>sessionID 儲存方式</li>
<li>session 資訊儲存方式</li>
</ol>
<p>可以先來看產生 sessionID 的地方：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the session id generate function</span></span><br><span class="line"><span class="keyword">var</span> generateId = opts.genid || generateSessionId</span><br><span class="line">  </span><br><span class="line"><span class="comment">// generates the new session</span></span><br><span class="line">store.generate = <span class="function"><span class="keyword">function</span>(<span class="params">req</span>)</span>&#123;</span><br><span class="line">  req.sessionID = generateId(req);</span><br><span class="line">  req.session = <span class="keyword">new</span> Session(req);</span><br><span class="line">  req.session.cookie = <span class="keyword">new</span> Cookie(cookieOptions);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (cookieOptions.secure === <span class="string">'auto'</span>) &#123;</span><br><span class="line">    req.session.cookie.secure = issecure(req, trustProxy);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateSessionId</span>(<span class="params">sess</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> uid(<span class="number">24</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>express-session 的客製化程度很高，可以自己傳進去產生 sessionID 的函式。若是沒有傳，預設會使用 <code>uid(24)</code>，這邊的 uid 指的是 <a href="https://github.com/crypto-utils/uid-safe" target="_blank" rel="noopener">uid-safe</a> 這個 library，會產生一個長度為 24 bytes 的隨機 ID。</p>
<p>文件上有特別說明這個長度：</p>
<blockquote>
<p>Asynchronously create a UID with a specific byte length. Because base64 encoding is used underneath, this is not the string length. For example, to create a UID of length 24, you want a byte length of 18.</p>
</blockquote>
<p>所以填入 24，最後產生出來的會是長度為 32 個字元的字串。</p>
<p>那這個 sessionID 是以什麼樣的形式存進 Cookie 的呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookie = <span class="built_in">require</span>(<span class="string">'cookie'</span>)</span><br><span class="line"><span class="keyword">var</span> signature = <span class="built_in">require</span>(<span class="string">'cookie-signature'</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment">// get the session cookie name</span></span><br><span class="line"><span class="keyword">var</span> name = opts.name || opts.key || <span class="string">'connect.sid'</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// get the cookie signing secret</span></span><br><span class="line"><span class="keyword">var</span> secret = opts.secret</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (secret &amp;&amp; !<span class="built_in">Array</span>.isArray(secret)) &#123;</span><br><span class="line">  secret = [secret];</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// set-cookie</span></span><br><span class="line">onHeaders(res, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// set cookie</span></span><br><span class="line">  setcookie(res, name, req.sessionID, secrets[<span class="number">0</span>], req.session.cookie.data);</span><br><span class="line">&#125;);</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setcookie</span>(<span class="params">res, name, val, secret, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> signed = <span class="string">'s:'</span> + signature.sign(val, secret);</span><br><span class="line">  <span class="keyword">var</span> data = cookie.serialize(name, signed, options);</span><br><span class="line">  </span><br><span class="line">  debug(<span class="string">'set-cookie %s'</span>, data);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> prev = res.getHeader(<span class="string">'Set-Cookie'</span>) || []</span><br><span class="line">  <span class="keyword">var</span> header = <span class="built_in">Array</span>.isArray(prev) ? prev.concat(data) : [prev, data];</span><br><span class="line">  </span><br><span class="line">  res.setHeader(<span class="string">'Set-Cookie'</span>, header)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>存在 cookie 裡面的 sessionID 的 key 一樣可以自己指定，但預設會是 <code>connect.sid</code>，所以以後一看到這個 key 就知道這是 express-session 預設的 sessionID 名稱。</p>
<p>內容的部分比較特別一點，會以 <code>s:</code> 開頭，後面接上 <code>signature.sign(sessionID, secret)</code> 的結果。</p>
<p>這邊要再看到 <a href="https://github.com/tj/node-cookie-signature" target="_blank" rel="noopener">cookie-signature</a> 這個 library，底下是一個簡單範例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cookie = <span class="built_in">require</span>(<span class="string">'cookie-signature'</span>);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> val = cookie.sign(<span class="string">'hello'</span>, <span class="string">'tobiiscool'</span>);</span><br><span class="line">val.should.equal(<span class="string">'hello.DGDUkGlIkCzPz+C0B064FNgHdEjox7ch8tOBGslZ5QI'</span>);</span><br></pre></td></tr></table></figure>
<p>這邊的 sign 到底做了什麼呢？原始碼很簡單，可以稍微看一下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sign the given `val` with `secret`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; val</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; secret</span></span><br><span class="line"><span class="comment"> * @return &#123;String&#125;</span></span><br><span class="line"><span class="comment"> * @api private</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  </span><br><span class="line">exports.sign = <span class="function"><span class="keyword">function</span>(<span class="params">val, secret</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> val) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"Cookie value must be provided as a string."</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'string'</span> != <span class="keyword">typeof</span> secret) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"Secret string must be provided."</span>);</span><br><span class="line">  <span class="keyword">return</span> val + <span class="string">'.'</span> + crypto</span><br><span class="line">    .createHmac(<span class="string">'sha256'</span>, secret)</span><br><span class="line">    .update(val)</span><br><span class="line">    .digest(<span class="string">'base64'</span>)</span><br><span class="line">    .replace(<span class="regexp">/\=+$/</span>, <span class="string">''</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>就只是把你要 sign 的內容用 hmac-sha256 產生一個<a href="https://zh.wikipedia.org/wiki/%E9%87%91%E9%91%B0%E9%9B%9C%E6%B9%8A%E8%A8%8A%E6%81%AF%E9%91%91%E5%88%A5%E7%A2%BC" target="_blank" rel="noopener">鑑別碼</a>，並且加在字串後面而已，中間會用<code>.</code>來分割資料。</p>
<p>若是你不知道什麼是 hmac 的話我稍微提一下，簡單來說就是可以對一串訊息產生鑑別碼，目的是為了保持資料的完整性讓它不被竄改。你可以想成它就是訊息對應到的一組獨一無二的代碼，如果訊息被改掉了，代碼也會不一樣。</p>
<p>以上面的範例來說，<code>hello</code> 利用 <code>tobiiscool</code> 這個 secret，得到的結果為：<code>DGDUkGlIkCzPz+C0B064FNgHdEjox7ch8tOBGslZ5QI</code>，於是完整字串就變為：<code>hello.DGDUkGlIkCzPz+C0B064FNgHdEjox7ch8tOBGslZ5QI</code>，前面是我的資料，後面是資料的鑑別碼。</p>
<p>如果有人想竄改資料，例如說把前面改成 hello2，那這個資料的鑑別碼就不會是後面那一串，我就知道有人篡改資料了。所以藉由這樣的方式來保持資料完整性，其實原理跟 <a href="https://jwt.io/" target="_blank" rel="noopener">JWT</a> 是差不多的，你看得到資料但沒辦法改它，因為改了會被發現。</p>
<p>你可能會疑惑說：那我幹嘛不把整個 sessionID 加密就好？為什麼要多此一舉用這種方式？我自己猜測是因為原始資料其實不怕別人看，只是怕人改而已；若是原始資料是敏感資訊，會用加密的方式。但因為原始資料只是 sessionID 而已，被別人看到也沒什麼關係，只要保障資料完整性即可。而且加密需要的系統資源應該比這種訊息驗證還多，因此才採用這種方式。</p>
<p>好，我們再講回來前面，所以 express-session 會把 sessionID 存在 cookie 裡面，key 是 <code>connect.sid</code>，value 則是 <code>s:{sessionID}.{hmac-sha256(sessionID, secret)}</code>。</p>
<p>好奇的話你可以去任何使用 Express 的網站然後看一下 cookie 內容，就可以找到實際的資料（或是自己隨便執行一個也行），這邊我用我的當作範例，我的 connect.sid 是： s%3AfZZVCDHefchle2LDK4PzghaR3Ao9NruG.J%2BsOPkTubkeMJ4EMBcnunPXW0Y7TWTucRSKIPNVgnRM，把特殊字元 decode 之後變成： <code>s:fZZVCDHefchle2LDK4PzghaR3Ao9NruG.J+sOPkTubkeMJ4EMBcnunPXW0Y7TWTucRSKIPNVgnRM</code>。</p>
<p>也就是說我的 sessionID 是<code>fZZVCDHefchle2LDK4PzghaR3Ao9NruG</code>，鑑別碼是<code>J+sOPkTubkeMJ4EMBcnunPXW0Y7TWTucRSKIPNVgnRM</code>。</p>
<p>知道儲存 sessionID 的方式以後，從 cookie 裡面取得 sessionID 的方式應該也能看懂，就是把事情反過來做而已：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get the session ID from the cookie</span></span><br><span class="line"><span class="keyword">var</span> cookieId = req.sessionID = getcookie(req, name, secrets);</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getcookie</span>(<span class="params">req, name, secrets</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> header = req.headers.cookie;</span><br><span class="line">  <span class="keyword">var</span> raw;</span><br><span class="line">  <span class="keyword">var</span> val;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// read from cookie header</span></span><br><span class="line">  <span class="keyword">if</span> (header) &#123;</span><br><span class="line">    <span class="keyword">var</span> cookies = cookie.parse(header);</span><br><span class="line">  </span><br><span class="line">    raw = cookies[name];</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (raw) &#123;</span><br><span class="line">      <span class="keyword">if</span> (raw.substr(<span class="number">0</span>, <span class="number">2</span>) === <span class="string">'s:'</span>) &#123;</span><br><span class="line">        val = unsigncookie(raw.slice(<span class="number">2</span>), secrets);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val === <span class="literal">false</span>) &#123;</span><br><span class="line">          debug(<span class="string">'cookie signature invalid'</span>);</span><br><span class="line">          val = <span class="literal">undefined</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        debug(<span class="string">'cookie unsigned'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Verify and decode the given `val` with `secrets`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &#123;String&#125; val</span></span><br><span class="line"><span class="comment"> * @param &#123;Array&#125; secrets</span></span><br><span class="line"><span class="comment"> * @returns &#123;String|Boolean&#125;</span></span><br><span class="line"><span class="comment"> * @private</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unsigncookie</span>(<span class="params">val, secrets</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; secrets.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = signature.unsign(val, secrets[i]);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (result !== <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下來就剩最後一個了，session 資訊到底存在哪裡？是存在記憶體、檔案，還是其他地方？</p>
<p>其實這個在程式碼裡面寫得很清楚了，預設是存在記憶體裡面的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> warning = <span class="string">'Warning: connect.session() MemoryStore is not\n'</span></span><br><span class="line">  + <span class="string">'designed for a production environment, as it will leak\n'</span></span><br><span class="line">  + <span class="string">'memory, and will not scale past a single process.'</span>;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// get the session store</span></span><br><span class="line"><span class="keyword">var</span> store = opts.store || <span class="keyword">new</span> MemoryStore()</span><br><span class="line">  </span><br><span class="line"><span class="comment">// notify user that this store is not</span></span><br><span class="line"><span class="comment">// meant for a production environment</span></span><br><span class="line"><span class="comment">/* istanbul ignore next: not tested */</span></span><br><span class="line"><span class="keyword">if</span> (env === <span class="string">'production'</span> &amp;&amp; store <span class="keyword">instanceof</span> MemoryStore) &#123;</span><br><span class="line">  <span class="built_in">console</span>.warn(warning);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那到底是怎麼存呢？可以參考 <a href="https://github.com/expressjs/session/blob/master/session/memory.js" target="_blank" rel="noopener">session/memory.js</a>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MemoryStore</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  Store.call(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">this</span>.sessions = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">MemoryStore.prototype.get = <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">sessionId, callback</span>) </span>&#123;</span><br><span class="line">  defer(callback, <span class="literal">null</span>, getSession.call(<span class="keyword">this</span>, sessionId))</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">MemoryStore.prototype.set = <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">sessionId, session, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.sessions[sessionId] = <span class="built_in">JSON</span>.stringify(session)</span><br><span class="line">  callback &amp;&amp; defer(callback)</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSession</span>(<span class="params">sessionId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> sess = <span class="keyword">this</span>.sessions[sessionId]</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!sess) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// parse</span></span><br><span class="line">  sess = <span class="built_in">JSON</span>.parse(sess)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> sess</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先用 <code>Object.create(null)</code> 創造出一個乾淨的 Object（這是很常用的一個方法，沒看過的可以參考：<a href="https://juejin.im/post/5acd8ced6fb9a028d444ee4e" target="_blank" rel="noopener">詳解 Object.create(null)</a>），然後以 sessionID 作為 key，<code>JSON.stringigy(session)</code>作為 value，存到這個 object 裡面。</p>
<p>所以說穿了其實 express-session 的 session information 預設就是存在一個變數裡面而已啦，因此你只要一把 process 結束掉重開，session 的資料就都全部不見了。而且會有 memory leak 的問題，所以官方也不推薦用在 production 上面。</p>
<p>如果要用在 production 上面，必須額外再找<code>store</code>來用，例如說 <a href="https://github.com/tj/connect-redis#readme" target="_blank" rel="noopener">connect-redis</a> 就可以跟 express-session 搭配，把 session information 存在 redis 裡。</p>
<p>以上就是 Express 常用的 middleware：express-session 的原始碼分析。從上面的段落我們清楚知道了 sessionID 的產生方式以及如何存在 cookie，還有 session information 所儲存的地方。</p>
<h2 id="PHP（7-2-版本）"><a href="#PHP（7-2-版本）" class="headerlink" title="PHP（7.2 版本）"></a>PHP（7.2 版本）</h2><p>PHP 內建就有 session 機制，不必使用任何的 framework，而使用的方法也很簡單：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($_SESSION[<span class="string">'views'</span>])) &#123;</span><br><span class="line">    $_SESSION[<span class="string">'views'</span>] = <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $_SESSION[<span class="string">'views'</span>]++;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">echo</span> $_SESSION[<span class="string">'views'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>其實跟 express-session 的用法有點像，只是一個是 <code>req.session</code>，一個是<code>$_SESSION</code>。</p>
<p>我原本也想跟剛剛看 express-session 一樣，直接去看 PHP 的原始碼，然後從中發現如何實作。但因為 PHP 的原始碼全部都是 C，對我這種幾乎沒寫過 C 的人來說很難看懂，因此我也只能反過來。先跟大家介紹 PHP 的 Session 機制是如何實作的，再從原始碼裡面去找證據支援。</p>
<p>首先呢，PHP 的 Session 機制與 express-session 差不多，都會在 Cookie 裡存放一個 sessionID，並且把 session information 存在伺服器。express-session 預設是存在記憶體，PHP 預設則是存在檔案裡面。</p>
<p>以上這些都可以在 PHP 的設定檔調整，都寫在 <code>php.ini</code> 裡面，底下以我的為例，列出一些相關的設定：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Session]</span></span><br><span class="line"><span class="comment">; Handler used to store/retrieve data.</span></span><br><span class="line"><span class="comment">; http://php.net/session.save-handler</span></span><br><span class="line"><span class="attr">session.save_handler</span>=files</span><br><span class="line">  </span><br><span class="line"><span class="comment">; Argument passed to save_handler.  In the case of files, this is the path</span></span><br><span class="line"><span class="comment">; where data files are stored. <span class="doctag">Note:</span> Windows users have to change this</span></span><br><span class="line"><span class="comment">; variable in order to use PHP's session functions.</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; The path can be defined as:</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">;     session.save_path = "N;/path"</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">session.save_path</span>=<span class="string">"/opt/lampp/temp/"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">; Name of the session (used as cookie name).</span></span><br><span class="line"><span class="comment">; http://php.net/session.name</span></span><br><span class="line"><span class="attr">session.name</span>=PHPSESSID</span><br><span class="line">  </span><br><span class="line"><span class="comment">; Handler used to serialize data.  php is the standard serializer of PHP.</span></span><br><span class="line"><span class="comment">; http://php.net/session.serialize-handler</span></span><br><span class="line"><span class="attr">session.serialize_handler</span>=php</span><br></pre></td></tr></table></figure>
<p>在 Cookie 裡面你就能看見一個 <code>PHPSESSID</code>，值大概長得像這樣：<code>fc46356f83dcf5712205d78c51b47c4d</code>，這就是 PHP 所使用的 sessionID。</p>
<p>接著你去 <code>session.save_path</code> 看，就會看到儲存你 session 資訊的檔案，檔名很好認，就是 <code>sess_</code> 加上 sessionID：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/opt/lampp/temp# ls</span><br><span class="line">  </span><br><span class="line">adminer.invalid</span><br><span class="line">adminer.version</span><br><span class="line">sess_04719a35fb67786d574ec6eca969f7cb</span><br><span class="line">sess_fc46356f83dcf5712205d78c51b47c4d</span><br></pre></td></tr></table></figure>
<p>若是打開 session 檔案，內容會是被序列化（serialize）之後的結果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">views|i:5;</span><br></pre></td></tr></table></figure>
<p>這就是 PHP session 的真面目了。把 session information 全都存在檔案裡面。</p>
<p>若是想要研究 PHP session 的相關原始碼，最重要的檔案就是這兩個：<a href="https://github.com/php/php-src/blob/PHP-7.2/ext/session/session.c" target="_blank" rel="noopener">ext/session/session.c</a> 跟 <a href="https://github.com/php/php-src/blob/PHP-7.2/ext/session/mod_files.c" target="_blank" rel="noopener">ext/session/mod_files.c</a>，前者管理 session 生命週期，後者負責把 session 實際存到檔案裡面或者是讀出來。後者其實就很像我們在 express-session 裡面看到的 Store，只要遵守一樣的 interface，就可以自己寫一個其他的 mod 出來，例如說 mod_redis.c 之類的。</p>
<p>接著我們一樣先來找找看 sessionID 是如何產生的，可以直接在 mod_files.c 搜尋相關字眼，就會找到底下這段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Create session ID.</span></span><br><span class="line"><span class="comment"> * PARAMETERS: PS_CREATE_SID_ARGS in php_session.h</span></span><br><span class="line"><span class="comment"> * RETURN VALUE: Valid session ID(zend_string *) or NULL for FAILURE.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * PS_CREATE_SID_FUNC() must check collision. i.e. Check session data if</span></span><br><span class="line"><span class="comment"> * new sid exists already.</span></span><br><span class="line"><span class="comment"> * *mod_data is guaranteed to have non-NULL value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> Default php_session_create_id() does not check collision. If</span></span><br><span class="line"><span class="comment"> * NULL is returned, session module create new ID by using php_session_create_id().</span></span><br><span class="line"><span class="comment"> * If php_session_create_id() fails due to invalid configuration, it raises E_ERROR.</span></span><br><span class="line"><span class="comment"> * NULL return value checks from php_session_create_id() is not required generally.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PS_CREATE_SID_FUNC(files)</span><br><span class="line">&#123;</span><br><span class="line">    zend_string *sid;</span><br><span class="line">    <span class="keyword">int</span> maxfail = <span class="number">3</span>;</span><br><span class="line">    PS_FILES_DATA;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        sid = php_session_create_id((<span class="keyword">void</span>**)&amp;data);</span><br><span class="line">        <span class="keyword">if</span> (!sid) &#123;</span><br><span class="line">            <span class="keyword">if</span> (--maxfail &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Check collision */</span></span><br><span class="line">        <span class="comment">/* <span class="doctag">FIXME:</span> mod_data(data) should not be NULL (User handler could be NULL) */</span></span><br><span class="line">        <span class="keyword">if</span> (data &amp;&amp; ps_files_key_exists(data, ZSTR_VAL(sid)) == SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sid) &#123;</span><br><span class="line">                zend_string_release(sid);</span><br><span class="line">                sid = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (--maxfail &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(!sid);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> sid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這邊呼叫了 <code>php_session_create_id</code> 來產生 sessionID，然後會檢查有沒有產生重複的 id，有的話就重試最多三次。而 <code>php_session_create_id</code> 則是存在於 session.c 那個檔案：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PS_EXTRA_RAND_BYTES 60</span></span><br><span class="line">  </span><br><span class="line"><span class="function">PHPAPI zend_string *<span class="title">php_session_create_id</span><span class="params">(PS_CREATE_SID_ARGS)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> rbuf[PS_MAX_SID_LENGTH + PS_EXTRA_RAND_BYTES];</span><br><span class="line">    zend_string *outid;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* Read additional PS_EXTRA_RAND_BYTES just in case CSPRNG is not safe enough */</span></span><br><span class="line">    <span class="keyword">if</span> (php_random_bytes_throw(rbuf, PS(sid_length) + PS_EXTRA_RAND_BYTES) == FAILURE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    outid = zend_string_alloc(PS(sid_length), <span class="number">0</span>);</span><br><span class="line">    ZSTR_LEN(outid) = bin_to_readable(rbuf, PS(sid_length), ZSTR_VAL(outid), (<span class="keyword">char</span>)PS(sid_bits_per_character));</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> outid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重點其實只有這一個：<code>php_random_bytes_throw</code>，這個 function 如果繼續追下去會找到 <a href="https://github.com/php/php-src/blob/623911f993f39ebbe75abe2771fc89faf6b15b9b/ext/standard/php_random.h#L32" target="_blank" rel="noopener">ext/standard/php_random.h</a>，然後找到 <a href="https://github.com/php/php-src/blob/8fc58a1a1d32dd288bf4b9e09f9302a99d7b35fe/ext/standard/random.c#L89" target="_blank" rel="noopener">ext/standard/random.c</a>，才是真正產生隨機數的地方。</p>
<p>但最後找到的那個 function 想要看懂必須花一大段時間，因此我就沒有細看了。總之在不同作業系統上會有不同的產生方式，其中一種還會使用到 <a href="https://zh.wikipedia.org/wiki//dev/random" target="_blank" rel="noopener">/dev/urandom</a>。</p>
<p>知道了 sessionID 的產生方式以後，我們來看看 PHP 的 session information 是怎麼做 serialize 的。可以在<a href="https://www.php.net/manual/en/function.session-encode.php" target="_blank" rel="noopener">官方文件</a>上看到一個 function 叫做：<code>session_encode</code>，輸出的結果跟我們在 session 檔案裡面看到的資料一模一樣，而這個 function 的敘述寫著：</p>
<blockquote>
<p>session_encode() returns a serialized string of the contents of the current session data stored in the $_SESSION superglobal.</p>
</blockquote>
<blockquote>
<p>By default, the serialization method used is internal to PHP, and is not the same as serialize(). The serialization method can be set using session.serialize_handler.</p>
</blockquote>
<p>接著我們直接在 session.c 裡面搜尋<code>session_encode</code>，會找到這一段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &#123;&#123;&#123; proto string session_encode(void)</span></span><br><span class="line"><span class="comment">   Serializes the current setup and returns the serialized representation */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">PHP_FUNCTION</span><span class="params">(session_encode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    zend_string *enc;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters_none() == FAILURE) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    enc = php_session_encode();</span><br><span class="line">    <span class="keyword">if</span> (enc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    RETURN_STR(enc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只是一個 <code>php_session_encode</code> 的 wrapper 而已，而且 <code>php_session_encode</code> 也只是再呼叫別的東西：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> zend_string *<span class="title">php_session_encode</span><span class="params">(<span class="keyword">void</span>)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IF_SESSION_VARS() &#123;</span><br><span class="line">        <span class="keyword">if</span> (!PS(serializer)) &#123;</span><br><span class="line">            php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">"Unknown session.serialize_handler. Failed to encode session object"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> PS(serializer)-&gt;encode();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span>, E_WARNING, <span class="string">"Cannot encode non-existent session"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br></pre></td></tr></table></figure>
<p><code>return PS(serializer)-&gt;encode();</code> 這一句才是重點。其實追到這邊的時候就有點卡住，因為不清楚這邊的 <code>serializer</code> 是從哪邊來的。但往下稍微看一下程式碼，找到一段應該是相關的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PS_DELIMITER <span class="meta-string">'|'</span></span></span><br><span class="line">  </span><br><span class="line">PS_SERIALIZER_ENCODE_FUNC(php) <span class="comment">/* &#123;&#123;&#123; */</span></span><br><span class="line">&#123;</span><br><span class="line">    smart_str buf = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">php_serialize_data_t</span> var_hash;</span><br><span class="line">    PS_ENCODE_VARS;</span><br><span class="line">  </span><br><span class="line">    PHP_VAR_SERIALIZE_INIT(var_hash);</span><br><span class="line">  </span><br><span class="line">    PS_ENCODE_LOOP(</span><br><span class="line">        smart_str_appendl(&amp;buf, ZSTR_VAL(key), ZSTR_LEN(key));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">memchr</span>(ZSTR_VAL(key), PS_DELIMITER, ZSTR_LEN(key))) &#123;</span><br><span class="line">            PHP_VAR_SERIALIZE_DESTROY(var_hash);</span><br><span class="line">            smart_str_free(&amp;buf);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        smart_str_appendc(&amp;buf, PS_DELIMITER);</span><br><span class="line">        php_var_serialize(&amp;buf, struc, &amp;var_hash);</span><br><span class="line">    );</span><br><span class="line">  </span><br><span class="line">    smart_str_0(&amp;buf);</span><br><span class="line">  </span><br><span class="line">    PHP_VAR_SERIALIZE_DESTROY(var_hash);</span><br><span class="line">    <span class="keyword">return</span> buf.s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br></pre></td></tr></table></figure>
<p>會知道相關是因為 <code>#define PS_DELIMITER &#39;|&#39;</code> 這一行，這個符號在 session 檔案裡有出現，可以猜測應該是拿來分隔什麼東西的。而實際的值則是交給<code>php_var_serialize</code>處理。</p>
<p><code>php_var_serialize</code>若是繼續往下追，可以找到 <a href="https://github.com/php/php-src/blob/7686b0b88906e2522300b9e631ddde2051de839f/ext/standard/var.c#L1112" target="_blank" rel="noopener">ext/standard/var.c</a>（直接用 GitHub 搜尋功能就可以找到這個檔案，搜尋功能超方便的），最後就會找到真正在處理的地方：<a href="https://github.com/php/php-src/blob/7686b0b88906e2522300b9e631ddde2051de839f/ext/standard/var.c#L883" target="_blank" rel="noopener">php_var_serialize_intern</a>，裡面會針對不同的形態去呼叫不同的 function。</p>
<p>以我們之前存在 session 裡面的 views 來說，是一個數字，所以會跑到這個 function：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">php_var_serialize_long</span><span class="params">(smart_str *buf, zend_long val)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    smart_str_appendl(buf, <span class="string">"i:"</span>, <span class="number">2</span>);</span><br><span class="line">    smart_str_append_long(buf, val);</span><br><span class="line">    smart_str_appendc(buf, <span class="string">';'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br></pre></td></tr></table></figure>
<p>追到這邊，就知道為什麼當初 session 序列化之後的結果是<code>views|i:5;</code>了。<code>|</code>拿來分隔 key 跟 value，i 代表著型態，5 代表實際的數字，; 則是結束符號。</p>
<p>以上就是 PHP Session 機制的相關原始碼分析，我們稍微看了如何產生 sessionID 以及 session information 如何做序列化。也知道了以預設的狀態來說，cookie 名稱會叫做 PHPSESSID，而且會以檔案的方式來儲存 session 的內容。</p>
<p>最後來分享兩個跟 PHP Session 有關的文章，都十分有趣：</p>
<ol>
<li><a href="https://blog.orange.tw/2018/10/hitcon-ctf-2018-one-line-php-challenge.html" target="_blank" rel="noopener">HITCON CTF 2018 - One Line PHP Challenge</a></li>
<li><a href="https://cyku.tw/lfi-leads-to-rce-via-session-file/" target="_blank" rel="noopener">[Web Security] 透過 LFI 引入 PHP session 檔案觸發 RCE</a></li>
</ol>
<h2 id="Rails（5-2-版本）"><a href="#Rails（5-2-版本）" class="headerlink" title="Rails（5.2 版本）"></a>Rails（5.2 版本）</h2><p>Rails 是一個 Ruby 的 Web 框架，俗稱 Ruby on Rails。會挑這一套是因為我本來就知道它儲存 session 的方法不太一樣。我當初只是好奇 Rails 怎麼生成 sessionID 的，於是就去 GitHub 的 repo 搜尋：session，然後找到這個檔案：<a href="https://github.com/rails/rails/blob/5-2-stable/actionpack/test/dispatch/session/cookie_store_test.rb" target="_blank" rel="noopener">rails/actionpack/test/dispatch/session/cookie_store_test.rb</a>，是個測試，但有時候測試其實對找程式碼幫助也很大，因為裡面會出現一堆相關的 function 跟參數。</p>
<p>我那時觀察了一陣子，發現裡面出現了很多次的 session_id，於是就改用這個關鍵字搜尋，找到了 <a href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/session/cookie_store.rb" target="_blank" rel="noopener">rails/actionpack/lib/action_dispatch/middleware/session/cookie_store.rb</a>，發現裡面的註解把 Rails 的 Session 實作方式寫得一清二楚：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This cookie-based session store is the Rails default. It is</span></span><br><span class="line"><span class="comment"># dramatically faster than the alternatives.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Sessions typically contain at most a user_id and flash message; both fit</span></span><br><span class="line"><span class="comment"># within the 4K cookie size limit. A CookieOverflow exception is raised if</span></span><br><span class="line"><span class="comment"># you attempt to store more than 4K of data.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The cookie jar used for storage is automatically configured to be the</span></span><br><span class="line"><span class="comment"># best possible option given your application's configuration.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you only have secret_token set, your cookies will be signed, but</span></span><br><span class="line"><span class="comment"># not encrypted. This means a user cannot alter their +user_id+ without</span></span><br><span class="line"><span class="comment"># knowing your app's secret key, but can easily read their +user_id+. This</span></span><br><span class="line"><span class="comment"># was the default for Rails 3 apps.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Your cookies will be encrypted using your apps secret_key_base. This</span></span><br><span class="line"><span class="comment"># goes a step further than signed cookies in that encrypted cookies cannot</span></span><br><span class="line"><span class="comment"># be altered or read by users. This is the default starting in Rails 4.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Configure your session store in &lt;tt&gt;config/initializers/session_store.rb&lt;/tt&gt;:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Rails.application.config.session_store :cookie_store, key: '_your_app_session'</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In the development and test environments your application's secret key base is</span></span><br><span class="line"><span class="comment"># generated by Rails and stored in a temporary file in &lt;tt&gt;tmp/development_secret.txt&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment"># In all other environments, it is stored encrypted in the</span></span><br><span class="line"><span class="comment"># &lt;tt&gt;config/credentials.yml.enc&lt;/tt&gt; file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If your application was not updated to Rails 5.2 defaults, the secret_key_base</span></span><br><span class="line"><span class="comment"># will be found in the old &lt;tt&gt;config/secrets.yml&lt;/tt&gt; file.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that changing your secret_key_base will invalidate all existing session.</span></span><br><span class="line"><span class="comment"># Additionally, you should take care to make sure you are not relying on the</span></span><br><span class="line"><span class="comment"># ability to decode signed cookies generated by your app in external</span></span><br><span class="line"><span class="comment"># applications or JavaScript before changing it.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Because CookieStore extends Rack::Session::Abstract::Persisted, many of the</span></span><br><span class="line"><span class="comment"># options described there can be used to customize the session cookie that</span></span><br><span class="line"><span class="comment"># is generated. For example:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Rails.application.config.session_store :cookie_store, expire_after: 14.days</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># would set the session cookie to expire automatically 14 days after creation.</span></span><br><span class="line"><span class="comment"># Other useful options include &lt;tt&gt;:key&lt;/tt&gt;, &lt;tt&gt;:secure&lt;/tt&gt; and</span></span><br><span class="line"><span class="comment"># &lt;tt&gt;:httponly&lt;/tt&gt;.</span></span><br></pre></td></tr></table></figure>
<p>Rails 預設使用 cookie-based session，因為它比其他解決方案都來得快。雖然 cookie 有大小限制，但頂多只會存 flash message 跟 user_id，離 4k 的上限還有一大段距離。</p>
<p>在 Rails 3 裡面 cookie 只會被 signed 不會被加密，意思就是使用者看得到 user_id 但沒辦法改它（就像我們在 express-session 看到的 sessionID 一樣，看得到但不能改）。</p>
<p>而 Rails 4 以後預設就會把 cookie 的值整個加密，什麼都看不到。在測試環境時 Rails 會自動幫你產生一個 secret 來加密，也可以透過 Rails 的設定檔來設定。</p>
<p>在這份檔案中也可以看到有一個 function 叫做<code>generate_sid</code>，是拿來產生 sessionID 的。這個 function 存在於 <a href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/session/abstract_store.rb" target="_blank" rel="noopener">rails/actionpack/lib/action_dispatch/middleware/session/abstract_store.rb</a>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_sid</span></span></span><br><span class="line">    sid = SecureRandom.hex(<span class="number">16</span>)</span><br><span class="line">    sid.encode!(Encoding::UTF_8)</span><br><span class="line">    sid</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>直接呼叫了 Ruby 的函式庫 <a href="https://ruby-doc.org/stdlib-2.5.1/libdoc/securerandom/rdoc/SecureRandom.html" target="_blank" rel="noopener">SecureRandom</a> 來產生亂數並當作 sessionID。</p>
<p>至於在 Cookie 裡面的 key 是什麼，可以經由設定 <code>app.config.session_store</code> 來調整。根據<a href="https://github.com/rails/rails/blob/5-2-stable/railties/lib/rails/application/finisher.rb#L39" target="_blank" rel="noopener">這邊</a>的程式碼：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Setup default session store if not already set in config/application.rb</span></span><br><span class="line">initializer <span class="symbol">:setup_default_session_store</span>, <span class="symbol">before:</span> <span class="symbol">:build_middleware_stack</span> <span class="keyword">do</span> <span class="params">|app|</span></span><br><span class="line">    <span class="keyword">unless</span> app.config.session_store?</span><br><span class="line">        app_name = app<span class="class">.<span class="keyword">class</span>.<span class="title">name</span> ? <span class="title">app</span>.<span class="title">railtie_name</span>.<span class="title">chomp</span>("<span class="title">_application</span>") : ""</span></span><br><span class="line">        app.config.session_store <span class="symbol">:cookie_store</span>, <span class="symbol">key:</span> <span class="string">"_<span class="subst">#&#123;app_name&#125;</span>_session"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>預設值會是 <code>_#{app_name}_session</code>，例如說我的 app_name 叫做 huli，Cookie 名稱就會是 _huli_session。</p>
<p>然後把 session information 實際寫進去 cookie 的地方在 <a href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/session/cookie_store.rb" target="_blank" rel="noopener">rails/actionpack/lib/action_dispatch/middleware/session/cookie_store.rb</a>：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_cookie</span><span class="params">(request, session_id, cookie)</span></span></span><br><span class="line">  cookie_jar(request)[@key] = cookie</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_cookie</span><span class="params">(req)</span></span></span><br><span class="line">  cookie_jar(req)[@key]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cookie_jar</span><span class="params">(request)</span></span></span><br><span class="line">  request.cookie_jar.signed_or_encrypted</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>會呼叫與 cookie 相關的 <code>signed_or_encrypted</code> 來做處理。</p>
<p>接著我去搜了一下文件，發現其實<a href="https://guides.rubyonrails.org/security.html#sessions" target="_blank" rel="noopener">官方文件</a>都寫得十分清楚了：</p>
<blockquote>
<p>The session ID is generated using SecureRandom.hex which generates a random hex string using platform specific methods (such as OpenSSL, /dev/urandom or Win32 CryptoAPI) for generating cryptographically secure random numbers. Currently it is not feasible to brute-force Rails’ session IDs.</p>
</blockquote>
<p>上面這段寫了 sessionID 的產生方式。</p>
<blockquote>
<p>The CookieStore uses the encrypted cookie jar to provide a secure, encrypted location to store session data. Cookie-based sessions thus provide both integrity as well as confidentiality to their contents. The encryption key, as well as the verification key used for signed cookies, is derived from the secret_key_base configuration value.</p>
<p>As of Rails 5.2 encrypted cookies and sessions are protected using AES GCM encryption. This form of encryption is a type of Authenticated Encryption and couples authentication and encryption in single step while also producing shorter ciphertexts as compared to other algorithms previously used. The key for cookies encrypted with AES GCM are derived using a salt value defined by the config.action_dispatch.authenticated_encrypted_cookie_salt configuration value.</p>
</blockquote>
<p>這段則是寫說從 Rails 5.2 開始採用 AES GCM 來加密，底下還有一個段落我沒複製，主要是提到之前程式碼註解裡面寫的，Rails 4 前只用 HMAC 來做驗證，而不是加密。</p>
<p>而且我看一看之後發現這文件寫的好棒喔，除了把這些機制說明清楚以外，底下還介紹了我們上一篇提到的 Session Fixation Attack 以及 CSRF。</p>
<p>若是還想深入研究，可以參考 Rails 裡面 Cookie 相關的實作：<a href="https://github.com/rails/rails/blob/5-2-stable/actionpack/lib/action_dispatch/middleware/cookies.rb" target="_blank" rel="noopener">rails/actionpack/lib/action_dispatch/middleware/cookies.rb</a>，註解裡面有詳細的說明，例如說加密的部分：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Returns a jar that'll automatically encrypt cookie values before sending them to the client and will decrypt them for read.</span></span><br><span class="line"><span class="comment"># If the cookie was tampered with by the user (or a 3rd party), +nil+ will be returned.</span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># If +secret_key_base+ and +secrets.secret_token+ (deprecated) are both set,</span></span><br><span class="line"><span class="comment"># legacy cookies signed with the old key generator will be transparently upgraded.</span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># If +config.action_dispatch.encrypted_cookie_salt+ and +config.action_dispatch.encrypted_signed_cookie_salt+</span></span><br><span class="line"><span class="comment"># are both set, legacy cookies encrypted with HMAC AES-256-CBC will be transparently upgraded.</span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># This jar requires that you set a suitable secret for the verification on your app's +secret_key_base+.</span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># Example:</span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment">#   cookies.encrypted[:discount] = 45</span></span><br><span class="line"><span class="comment">#   # =&gt; Set-Cookie: discount=DIQ7fw==--K3n//8vvnSbGq9dA--7Xh91HfLpwzbj1czhBiwOg==; path=/</span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment">#   cookies.encrypted[:discount] # =&gt; 45</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypted</span></span></span><br><span class="line">  @encrypted <span class="params">||</span>= EncryptedKeyRotatingCookieJar.new(<span class="keyword">self</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>往底下追的話就可以看到 <code>EncryptedKeyRotatingCookieJar</code> 的完整程式碼，或你也可以再往下，看看 <a href="https://github.com/rails/rails/blob/5-2-stable/activesupport/lib/active_support/message_encryptor.rb" target="_blank" rel="noopener">rails/activesupport/lib/active_support/message_encryptor.rb</a>，負責加密的程式碼長這樣：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_encrypt</span><span class="params">(value, **metadata_options)</span></span></span><br><span class="line">    cipher = new_cipher</span><br><span class="line">    cipher.encrypt</span><br><span class="line">    cipher.key = @secret</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Rely on OpenSSL for the initialization vector</span></span><br><span class="line">    iv = cipher.random_iv</span><br><span class="line">    cipher.auth_data = <span class="string">""</span> <span class="keyword">if</span> aead_mode?</span><br><span class="line">  </span><br><span class="line">    encrypted_data = cipher.update(Messages::Metadata.wrap(@serializer.dump(value), metadata_options))</span><br><span class="line">    encrypted_data &lt;&lt; cipher.final</span><br><span class="line">  </span><br><span class="line">    blob = <span class="string">"<span class="subst">#&#123;<span class="symbol">:</span><span class="symbol">:Base64</span>.strict_encode64 encrypted_data&#125;</span>--<span class="subst">#&#123;<span class="symbol">:</span><span class="symbol">:Base64</span>.strict_encode64 iv&#125;</span>"</span></span><br><span class="line">    blob = <span class="string">"<span class="subst">#&#123;blob&#125;</span>--<span class="subst">#&#123;<span class="symbol">:</span><span class="symbol">:Base64</span>.strict_encode64 cipher.auth_tag&#125;</span>"</span> <span class="keyword">if</span> aead_mode?</span><br><span class="line">    blob</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>這裡的 cipher 是從 openssl 來的，所以最底層是使用了 openssl。</p>
<p>整理到這邊應該就差不多了，就不再繼續深入了。</p>
<h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><p>在這篇裡面我們看了三個不同的 Session 儲存方式。第一種是 express-session，把 session information 存在記憶體裡面；第二種是 PHP，存在檔案裡面；最後一種則是 Rails，採用了之前提過的 cookie-based session，將資訊直接加密並且存在 cookie 裡。</p>
<p>在這系列當中，第一篇文章我們理解了概念，第二篇利用讀 RFC 加深印象並重新理解了一次 Session，最後一篇則是直接參考一些主流框架的實作，看看我們之前所提到的 sessionID 應該如何產生，session information 應該存在哪裡，cookie-bases session 又應該如何實作。</p>
<p>寫這系列的初衷就是想讓大家把這些概念一次理解清楚，就不用以後每次碰到都重新查一遍。</p>
<p>最後，希望這系列對大家有幫助，有任何錯誤都可以在底下留言反映。</p>
<p>底下是系列文的完整清單：</p>
<ol>
<li><a href="https://medium.com/@hulitw/session-and-cookie-15e47ed838bc" target="_blank" rel="noopener">白話 Session 與 Cookie：從經營雜貨店開始</a></li>
<li><a href="https://github.com/aszx87410/blog/issues/45" target="_blank" rel="noopener">淺談 Session 與 Cookie：一起來讀 RFC</a></li>
<li><a href="https://github.com/aszx87410/blog/issues/46" target="_blank" rel="noopener">深入 Session 與 Cookie：Express、PHP 與 Rails 的實作</a></li>
</ol>
<p>關於作者：<br><a href="https://medium.com/@hulitw" target="_blank" rel="noopener">@huli</a> 野生工程師，相信分享與交流能讓世界變得更美好</p>
  
      <div>喜歡我們的文章嗎？歡迎分享按讚給予我們支持和鼓勵！</div>
      <div class="fb-like" data-href="https://blog.techbridge.cc/2019/09/07/session-and-cookie-implementation/index.html" data-layout="button_count" data-action="like" data-size="large" data-show-faces="false" data-share="true"></div>
      <br>
      <br>
      <div class="fb-page" data-href="https://www.facebook.com/techbridge.cc" data-small-header="false" data-adapt-container-width="true" data-hide-cover="false" data-show-facepile="true"><blockquote cite="https://www.facebook.com/techbridge.cc" class="fb-xfbml-parse-ignore"><a href="https://www.facebook.com/techbridge.cc">TechBridge 技術日報</a></blockquote></div>
      <br>
    </section>
    <br>
    <hr>
    <div>
      <h4>訂閱 TechBridge Weekly 技術週刊，每週發送最精華的技術開發、產品設計的資訊給您</h4>
      <form class="form-control" method="post" action="https://goodbits.io/e/cab8a418-6b70-48d6-97ea-b5f0ef34b22c" target="_blank">
        <input class="form-control" type="text" name="first_name" placeholder="First Name"></input>
        <input class="form-control" type="text" name="last_name" placeholder="Last Name"></input>
        <div>
          <input class="form-control" type="text" name="email" placeholder="Email"></input>
        </div>
        <br>
        <div>
          <button class="form-control btn subscribe-btn" type="submit">馬上訂閱技術週刊</button>
        </div>
        <br>
        <label for="">PS. 我們討厭垃圾信，所以我們只提供有價值的內容給您 :)</label>
      </form>
    </div>
    <footer class="post-footer">
      <section class="author">
    <h4>TechBridge Weekly 技術週刊編輯團隊</h4>
    <p>TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、資料科學與產品設計等技術分享。This is TechBridge Weekly Team Tech Blog, which focus on web, mobile, robotics, IoT, Data Science technology sharing.</p>
    <span><a href="/2016/03/19/about/">關於我們</a></span> / <span><a href="https://www.techbridge.cc/" target="_blank">技術日報</a></span> / <span><a href="http://weekly.techbridge.cc/" target="_blank">技術週刊</a></span> / <span><a href="https://www.facebook.com/techbridge.cc/" target="_blank">粉絲專頁</a></span> / <span><a href="/atom.xml" target="_blank">訂閱RSS </a></span>   
	<div class="fb-like" data-href="https://www.facebook.com/techbridge.cc" data-layout="button_count" data-size="large" data-action="like" data-show-faces="false" data-share="true"></div>    
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=https://blog.techbridge.cc/2019/09/07/session-and-cookie-implementation/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.techbridge.cc/2019/09/07/session-and-cookie-implementation/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://blog.techbridge.cc/2019/09/07/session-and-cookie-implementation/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
    <iframe src="https://ghbtns.com/github-btn.html?user=TechBridgeHQ&repo=blog-starter-kit&type=star&count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>      
</section>
    </footer>
    <br>
  </article>
  <nav class="pagination" role="pagination">
    <h2>更多優質技術文章</h2>
    
    <a class="newer-posts" href="/2019/09/09/observablehq-intro/">
        ← 從製作 visfest 2019 badge 認識 ObservableHQ
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2019/08/30/leetcode-pattern-two-pointer/">
        Leetcode 刷題 pattern - Two Pointer →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">留言討論</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75308642-1', 'auto');
  ga('send', 'pageview');

</script>
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="/atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">TechBridge 技術共筆部落格</a> &copy; 2017 &bull; All rights reserved.</section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>


<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '[object Object]']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>


<script type="text/javascript">
    var disqus_shortname = 'techbridgeweekly';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.4/dist/medium-zoom.min.js"></script>
<script>
// NodeList
mediumZoom(document.querySelectorAll('img'));
</script>
  <div id="fb-root"></div>
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
