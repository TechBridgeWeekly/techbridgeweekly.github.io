<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>進階 React Component Patterns 筆記（下） | TechBridge 技術共筆部落格</title>
  <meta name="description" content="TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、數據分析與產品設計等技術分享" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- google-site-verification -->
  <meta name="google-site-verification" content="WX_9sZlrIYOEpy8RR7zCoa7-pJk611zZt11BSBUcDVY" />
  <link rel="stylesheet preload" type="text/css" href="/css/screen.css" as="style" />
  <link rel="stylesheet preload" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" as="style" />

  <!-- Favicons -->
  <link rel="apple-touch-icon" href="/img/favicon.ico">
  <link rel="icon preload" href="/img/favicon.ico" as="image">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  
</head>


<body class="post-template">

  <header class="site-head" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="/img/logo-tb-500-500.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">TechBridge 技術共筆部落格</h1>
            <h2 class="blog-description">var topics = ['Web前後端', '行動網路', '機器人/物聯網', '數據分析', '產品設計', 'etc.']</h2>
            <div class="navbar-block">
                <span><a href="/">首頁</a></span> / <span><a href="/about/">關於我們</a></span> / <span><a href="http://weekly.techbridge.cc/" target="_blank">技術週刊</a></span> / <span><a href="https://www.facebook.com/techbridge.cc/" target="_blank">粉絲專頁</a></span> / <span><a href="/atom.xml" target="_blank">訂閱RSS </a></span>
                <br>
            </div>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2018-07-21T23:33:27.000Z" itemprop="datePublished">
          2018-07-21
      </time>
    
    
    | 
    <a href='/tags/react/'>react</a>,
    
    <a href='/tags/es6/'>es6</a>,
    
    <a href='/tags/javascript/'>javascript</a>,
    
    <a href='/tags/pattern/'>pattern</a>
    
    
</span>

<meta name="generator" content="進階 React Component Patterns 筆記（下）">
<meta name="og:title" content="進階 React Component Patterns 筆記（下）">
<meta name="og:description" content="TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、數據分析與產品設計等技術分享。">
<meta name="og:type" content="website">
<meta name="og:image" content="/img/og-cover.png">

    <h1 class="post-title">進階 React Component Patterns 筆記（下）</h1>
    <section class="post-content">
      <div class="fb-like" data-href="https://www.facebook.com/techbridge.cc" data-layout="button_count" data-action="like" data-size="large" data-show-faces="false" data-share="true"></div>   
      <hr>
      <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上次我們介紹了三種 Rect Component Patterns，包含 <code>Compound component</code>、<code>Render props component</code> 與 <code>Prop collections &amp; getters</code>，而今天要繼續往下介紹剩下的五個 Patterns:</p>
<ul>
<li>State Initializers</li>
<li>State Reducer</li>
<li>Control Props</li>
<li>Provider</li>
<li>Higher-order component</li>
</ul>
<p>若對前三個 Pattern 不熟悉，或是沒看過上一篇文章的可以移駕至 <a target="_blank" rel="noopener" href="https://blog.arvinh.info/2018/06/27/advanced-react-component-patterns-note/">進階 React Component Patterns 筆記（上）</a></p>
<p>接下來的 Pattern 都會延續之前的 Demo 範例，所以建議先閱讀過上篇！</p>
<p>此外，每個 Pattern 的最後都放有 codesandbox 的 demo link，覺得文字太多的可以直接去看完整的 code 喔！</p>
<h1 id="State-Initializers"><a href="#State-Initializers" class="headerlink" title="State Initializers"></a>State Initializers</h1><p>有時候我們會希望能讓元件回復到初始狀態，或是能讓使用者自己定義初始狀態，這時就適合採用 State initializer 技巧。</p>
<p>首先，我們利用自定義的 <code>initialState</code> 來存放元件初始狀態，而在真正的 state 中去 reference 它：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Toggle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123; <span class="attr">onToggle</span>: <span class="function">() =&gt;</span> &#123; &#125; &#125;;</span><br><span class="line">  initialState = &#123; <span class="attr">on</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">  state = <span class="variable language_">this</span>.<span class="property">initialState</span>;</span><br><span class="line">  <span class="comment">// ...other function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這樣一來，要實作 <code>reset</code> 函式就相當簡單了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reset = <span class="function">() =&gt;</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="variable language_">this</span>.<span class="property">initialState</span>, <span class="function">() =&gt;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onReset</span>(<span class="variable language_">this</span>.<span class="property">initialState</span>)</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<p>而要讓使用者能自定義元件初始狀態的方式，相信多數讀者都有用過，也就是讓使用者透過 props 來定義元件的 initial state：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Toggle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123; <span class="attr">onToggle</span>: <span class="function">() =&gt;</span> &#123; &#125;, <span class="attr">initialOn</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">  initialState = &#123; <span class="attr">on</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">initialOn</span> &#125;;</span><br><span class="line">  state = <span class="variable language_">this</span>.<span class="property">initialState</span>;</span><br><span class="line">  <span class="comment">// ...other function</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由於並不是所有使用者都會自行定義初始狀態，所以別忘了在 <code>defaultProps</code> 中宣告我們自己希望的初始值喔！</p>
<p><a target="_blank" rel="noopener" href="https://codesandbox.io/embed/2wp3jr6o8j">Demo link</a></p>
<p>上面的 Demo 範例是延續<a target="_blank" rel="noopener" href="https://blog.arvinh.info/2018/06/27/advanced-react-component-patterns-note/">上篇</a>提到的 <code>Prop collections &amp; getters</code> 與 <code>Render props</code>，所以這邊加入的 <code>reset</code> 按鈕要記得加入 <code>getStateAndHelpers</code> 中傳遞給 <code>render props</code> 中的 children 使用。</p>
<h1 id="State-Reducer"><a href="#State-Reducer" class="headerlink" title="State Reducer"></a>State Reducer</h1><p>State Reducer 是一個蠻有趣的概念，主要目的是讓使用者能夠介入元件狀態改變的行為，讓元件在每次的 <code>setState</code> 時，都能夠被使用者影響。</p>
<p>舉個簡單的範例，像是我們先前的 Toggle component，如果今天使用者提出個需求，想要讓這個元件只能被 toggle 三次，那我們該怎麼做呢？</p>
<p>你當然可以讓使用者多傳一個 props 控制次數，然後在內部更動狀態時去檢查有沒有超過那個次數：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Toggle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">    <span class="attr">onToggle</span>: <span class="function">() =&gt;</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">onReset</span>: <span class="function">() =&gt;</span> &#123;&#125;,</span><br><span class="line">    <span class="attr">initialOn</span>: <span class="literal">false</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 元件內部多一個 toggleTimes 來控制目前的 toggle 次數</span></span><br><span class="line">  initialState = &#123; <span class="attr">on</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">initialOn</span>, <span class="attr">currentToggleTimes</span>: <span class="number">0</span> &#125;;</span><br><span class="line">  state = <span class="variable language_">this</span>.<span class="property">initialState</span>;</span><br><span class="line">  reset = <span class="function">() =&gt;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="variable language_">this</span>.<span class="property">initialState</span>, <span class="function">() =&gt;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onReset</span>(<span class="variable language_">this</span>.<span class="property">initialState</span>)</span><br><span class="line">    );</span><br><span class="line">  toggle = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 每次 toggle 時判斷有沒有超過使用者定義的 toggle 次數上限</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">currentToggleTimes</span> &gt;= <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">toggleTimes</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;toggle too much&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(</span><br><span class="line">      <span class="function">(<span class="params">&#123; on &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">on</span>: !on,</span><br><span class="line">        <span class="attr">currentToggleTimes</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">currentToggleTimes</span> + <span class="number">1</span> &#125;),</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onToggle</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">on</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...other methods</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但你也知道使用者的需求總是會變動，假如他突然間也想控制 reset 的次數怎麼辦? 你的程式不就改不完？</p>
<p>這時我們就能採用 <code>State Reducer</code>，先看一下使用者應該會怎麼使用 <code>State Reducer</code>：<br>｀</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  initialState = &#123; <span class="attr">timesClicked</span>: <span class="number">0</span> &#125;</span><br><span class="line">  state = <span class="variable language_">this</span>.<span class="property">initialState</span></span><br><span class="line">  toggleStateReducer = <span class="function">(<span class="params">state, changes</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// state 為 Toggle 的 current state</span></span><br><span class="line">    <span class="comment">// changes 為該次 Toggle 動作所造成的改變</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">timesClicked</span> &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; ...changes, <span class="attr">on</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> changes</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Toggle</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">initialOn</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onToggle</span>=<span class="string">&#123;on</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            this.setState((&#123; timesClicked &#125;) =&gt; (&#123;</span></span><br><span class="line"><span class="language-xml">               timesClicked: timesClicked + 1,</span></span><br><span class="line"><span class="language-xml">             &#125;))</span></span><br><span class="line"><span class="language-xml">          &#125;&#125;</span></span><br><span class="line"><span class="language-xml">          onReset=&#123;initialState =&gt; this.setState(this.initialState)&#125;</span></span><br><span class="line"><span class="language-xml">          stateReducer=&#123;this.toggleStateReducer&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          &#123;(&#123; on, getTogglerProps, reset &#125;) =&gt; (</span></span><br><span class="line"><span class="language-xml">            // render props</span></span><br><span class="line"><span class="language-xml">          )&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我們讓使用者傳入一個 <code>stateReducer</code>，其中接受兩個參數，一個是 Toggle component 的 current state，另一個是該次 Toggle component 執行 <code>setState</code> 時，所接受的變化 <code>changes</code>，而回傳值就是 Toggle component 實際 <code>setState</code> 時所接受的 change object。</p>
<p>因此在這個函式中，使用者就擁有了一個機會能夠在元件真正觸發 <code>setState</code> 之前，進行一些操作，以剛剛例子來說，就能在這邊判斷使用者自己紀錄的 state(<code>timesClicked</code>) 有沒有超過某個值，如果超過了，那我們之後每次的回傳結果中，都會將 <code>on</code> 這個 state 設為 false。</p>
<p>那元件本身該如何讓 <code>stateReducer</code> 介入 <code>setState</code> 中呢？重點就在這段：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">internalSetState</span>(<span class="params">changes, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">currentState</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 確認傳入的 changes 是單純的物件，或是函式</span></span><br><span class="line">      <span class="keyword">const</span> changesObject =</span><br><span class="line">        <span class="keyword">typeof</span> changes === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">changes</span>(currentState) : changes</span><br><span class="line">      <span class="comment">// 呼叫使用者傳入的 stateReducer 來取得最終的 state change object</span></span><br><span class="line">      <span class="keyword">const</span> reducedChanges =</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">stateReducer</span>(currentState, changesObject) || &#123;&#125;</span><br><span class="line">      <span class="comment">// 最後只是檢查一下 changes 是否為空，避免重複 render</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducedChanges).<span class="property">length</span></span><br><span class="line">        ? reducedChanges</span><br><span class="line">        : <span class="literal">null</span></span><br><span class="line">    &#125;, callback)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>我們需要建立一個介面與原本 <code>setState</code> 相同的 <code>internalSetState</code> 的方法，取代原本的 <code>setState</code>。</p>
<p>其中需要注意的有兩點，一個是原本的 <code>setState</code> 是能接受函式當第一個參數的，因此我們需要先判斷 <code>changes</code> 是否為 function，才能繼續進行其他動作。</p>
<p>另一個則是並非所有的 <code>setState</code> 都一定要用 <code>internalSetState</code> 取代，像是 <code>reset</code> function 我們可能不太希望使用者能介入，應該要很明確的 reset 所有狀態，因此這邊可以用原本的 <code>setState</code>。</p>
<p>看看 <a target="_blank" rel="noopener" href="https://codesandbox.io/embed/wyl152o1jw">Demo Link</a> ，並實際玩玩看會更清楚！</p>
<p>另外，在 Kent C. Dodds 的 workshop 中，他在 internalSetState 的實作上有提到一種他比較偏好的寫法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">internalSetState</span>(<span class="params">changes, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function"><span class="params">currentState</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> [changes]</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> <span class="keyword">typeof</span> c === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">changes</span>(currentState) : c)</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">stateReducer</span>(currentState, c) || &#123;&#125;)</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function"><span class="params">c</span> =&gt;</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducedChanges).<span class="property">length</span> ? c : <span class="literal">null</span>)[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>透過硬轉成 array 後，再用 map 將每個步驟 chain 起來，的確比較乾淨跟簡單，但比起原本做法沒那麼直覺就是了，尤其是最後還要取 <code>[0]</code> 出來，但參考一下也不錯！</p>
<p>透過 <code>State Reducer</code>，不僅使用者開心（能夠介入元件 state 的更動），開發者也不用疲於奔命一直改 code（讓使用者自己處理 reducer 實際內容），但壞處就是你需要呼叫一個 <code>internalSetState</code> 的函式，蠻可能造成 trace code 上的困擾，算是個 trade-off。</p>
<h1 id="Control-Props"><a href="#Control-Props" class="headerlink" title="Control Props"></a>Control Props</h1><p>除非你從來沒有用 React 開發與表單相關的 component，否則你一定用過 <code>Control Props</code>，因為所謂的 <code>Control Props</code> 其實就是 <code>Controlled component</code> 的一種實作。</p>
<p>舉例來說，<code>Select</code>, <code>Input</code> 等 <code>Form</code> 的元件，當使用者輸入值時，其改變的是元件的內部狀態，該狀態通常綁定在 <code>value</code> 這個屬性上頭。</p>
<p>若在 React 中想要取得使用者輸入進表單元件的值時，你就會想要將 state 綁定在元件的 <code>value</code> 上頭，然而，一但你傳值給 <code>value</code>（也就是 <code>value=&#123;this.state.value&#125;</code>），你就必須要自己利用 handler 去控制它的狀態改變，否則使用者再怎麼輸入，都不會改變其狀態。因為在你傳值給 <code>value</code> 的時候，這個元件就已經歸你控制了，這樣的方式可以保證該元件內部狀態是 single source of truth，不會有使用者的輸入與你的 state 不一致的狀態發生。（關於 <code>Controlled component</code> 在 React 官方網站有詳細的<a target="_blank" rel="noopener" href="https://reactjs.org/docs/forms.html">介紹</a>）</p>
<p>所以說，<code>Control Props</code> 就是想利用這樣的技巧，讓你的元件在讓使用者自行操作 input 時，能確保元件內部狀態的 single source of truth。透過這種方式，也就能夠從使用者角度來同步多個元件的內部狀態。</p>
<p>一樣已先前的 Toggle 元件來舉例，但這次我們用個簡化版：</p>
<p>假設今天使用者想同步兩個元件的狀態，他們可以透過本身的 <code>State</code> 來控制，並在 <code>onToggle</code> 時來更動 <code>State</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  state = &#123; <span class="attr">bothOn</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">  handleToggle = <span class="function"><span class="params">on</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">bothOn</span>: on &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Toggle</span> <span class="attr">on</span>=<span class="string">&#123;this.state.bothOn&#125;</span> <span class="attr">onToggle</span>=<span class="string">&#123;this.handleToggle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           &#123;(&#123; on, toggle &#125;) =&gt; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              &#123;on ? &quot;The button is on&quot; : &quot;The button is off&quot;&#125;</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;toggle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;on ? &quot;click on&quot; : &quot;click off&quot;&#125;</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          )&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Toggle</span> <span class="attr">on</span>=<span class="string">&#123;this.state.bothOn&#125;</span> <span class="attr">onToggle</span>=<span class="string">&#123;this.handleToggle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;(&#123; on, toggle &#125;) =&gt; (</span></span><br><span class="line"><span class="language-xml">            // same render props as above</span></span><br><span class="line"><span class="language-xml">          )&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但要記得，<code>onToggle</code> 實際上是 <code>Toggle</code> 元件內部執行完 <code>toggle</code> 後才會執行的動作（告知使用者該元件”被” Toggle 了），這樣的話，元件要怎麼依照傳入的 Props 來處理內部狀態呢？</p>
<p>來看一下我們 Toggle 的實作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Toggle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  state = &#123; <span class="attr">on</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">  <span class="title function_">isControlled</span>(<span class="params">prop</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>[prop] !== <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(<span class="variable language_">this</span>.<span class="property">state</span>).<span class="title function_">reduce</span>(<span class="function">(<span class="params">combinedState, [key, value]</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isControlled</span>(key)) &#123;</span><br><span class="line">        combinedState[key] = <span class="variable language_">this</span>.<span class="property">props</span>[key];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        combinedState[key] = value;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> combinedState;</span><br><span class="line">    &#125;, &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  toggle = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isControlled</span>(<span class="string">&quot;on&quot;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onToggle</span>(!<span class="variable language_">this</span>.<span class="title function_">getState</span>().<span class="property">on</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(</span><br><span class="line">        <span class="function">(<span class="params">&#123; on &#125;</span>) =&gt;</span> (&#123; <span class="attr">on</span>: !on &#125;),</span><br><span class="line">        <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onToggle</span>(<span class="variable language_">this</span>.<span class="title function_">getState</span>().<span class="property">on</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">children</span>(&#123; ...<span class="variable language_">this</span>.<span class="title function_">getState</span>(), <span class="attr">toggle</span>: <span class="variable language_">this</span>.<span class="property">toggle</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要重點在於，每次 <code>toggle</code> 被 trigger 時，我們都會先去確認一下 <code>on</code> 這個 state 有沒有被使用者 <code>Controlled</code>（<code>isControlled()</code>），若是使用者有透過 <code>props</code>（使用者端）傳值給這個 <code>state</code>（元件內部），就代表我們得將該 <code>state</code> 的掌控交給使用者。</p>
<p>什麼叫『交給使用者』呢？</p>
<p>其實也就是要將使用者傳入的 props 與我們自己本身的 state 做 <strong>combination</strong>，並將結果當作元件實際的 state 來使用，如同上述程式碼中的 <code>getState()</code> 函數。之後元件所有需要操作 state 的地方都需要透過該函數來取得元件的 <strong>Current State</strong>。</p>
<p>如此一來，只要使用者有傳入 <code>on</code> 這個 props，元件內部關於 <code>on</code> 這個 state 的變化，就會像是由使用者本身操控一般（因為我們在每次取得 current state 時都會 merge props 中對應的值），也就能讓使用者同步多個 <code>Toggle</code> component 了！</p>
<p><code>Control Props</code> 用文字敘述比較繁瑣難懂，可以到下面的 demo link 玩玩，試著把 <code>Toggle</code> component 的 <code>on</code> props 拿掉看看差別，拿掉 props 後，兩個元件的狀態就無法同步，但元件本身的狀態還是正常的。<br><a target="_blank" rel="noopener" href="https://codesandbox.io/embed/p94nmr2p2m">demo link</a></p>
<p>在 Kent C. Dodds 的 workshop 中，他其實還有介紹如何整合先前的 <code>State Reducer</code> 與 <code>Control Props</code>，不過我覺得過於複雜，除了很難光用文字敘述外，實際使用的機會感覺也不大，如果有興趣的讀者可以直接去 <a target="_blank" rel="noopener" href="https://codesandbox.io/s/github/kentcdodds/advanced-react-patterns-v2">codesandbox</a> 上看範例(file 10.js)</p>
<h1 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h1><p>Provider pattern 其實是為了解決 <code>Props drilling</code> 的問題，什麼是 <code>Props drilling</code> 呢？</p>
<p>舉個簡單例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Toggle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  state = &#123; <span class="attr">on</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">  toggle = <span class="function">() =&gt;</span> &#123; <span class="comment">/*...*/</span> &#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">children</span>(&#123; ...<span class="variable language_">this</span>.<span class="property">state</span>, <span class="attr">toggle</span>: <span class="variable language_">this</span>.<span class="property">toggle</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Layer1</span> = (<span class="params">&#123;toggle, ...props&#125;</span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">Layer2</span> <span class="attr">toggle</span>=<span class="string">&#123;toggle&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Layer2</span> = (<span class="params">&#123;toggle, ...props&#125;</span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">Layer3</span> <span class="attr">toggle</span>=<span class="string">&#123;toggle&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Layer3</span> = (<span class="params">&#123;toggle, ...props&#125;</span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;toggle&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  handleToggle = <span class="function">() =&gt;</span> &#123;&#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">Toggle</span> <span class="attr">onToggle</span>=<span class="string">&#123;this.handleToggle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Layer1</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我知道這段 code 很奇怪，但這裡想呈現的重點是，有些時候我們可能真的想要把某個外層的 props 往下傳遞給底下的 component，這種情況下可能得一層一層將 props 往下帶，即便中間經過的 component 都不需要用到該 props。</p>
<p>要解決這樣的問題，可以利用 React 的 <a target="_blank" rel="noopener" href="https://medium.com/dailyjs/reacts-%EF%B8%8F-new-context-api-70c9fe01596b"><code>Context API</code></a>。</p>
<p>雖然在 React 16 以前，<code>Context API</code> 在官方文件是一直處於一種不推薦使用的狀態，但大概因為太多人需要吧（像是 <code>redux</code> 等 state management 其實都有用到），現在有了新的實作，讓我們終於可以放心使用 <code>Context API</code> 了，因此這邊要介紹的 <code>Provider pattern</code>，其實就是利用 React 最新的 <code>Context API</code> 來解決 <code>Props drilling</code> 問題！</p>
<p>早在<a target="_blank" rel="noopener" href="https://blog.arvinh.info/2018/06/27/advanced-react-component-patterns-note/">上篇</a>中介紹的 <code>Compound component</code> 我們就有用到 Provider pattern 了，而現在就讓我們用剛剛那個離奇的例子來做點修正吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ToggleContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>();</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Toggle</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title class_">Consumer</span> = <span class="title class_">ToggleContext</span>.<span class="property">Consumer</span>;</span><br><span class="line">  toggle = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function">(<span class="params">&#123; on &#125;</span>) =&gt;</span> (&#123; <span class="attr">on</span>: !on &#125;));</span><br><span class="line">  state = &#123; <span class="attr">on</span>: <span class="literal">false</span>, <span class="attr">toggle</span>: <span class="variable language_">this</span>.<span class="property">toggle</span> &#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; children, ...rest &#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">    <span class="keyword">const</span> ui = <span class="keyword">typeof</span> children === <span class="string">&quot;function&quot;</span> ? <span class="title function_">children</span>(<span class="variable language_">this</span>.<span class="property">state</span>) : children;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">ToggleContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;this.state&#125;</span> &#123;<span class="attr">...rest</span>&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;ui&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ToggleContext.Provider</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用 React 16 後出現的 <code>React.createContext()</code>，創造一個 <code>ToggleContext</code>，並將其提供的 <code>Consumer</code> 當作 static 變數放在 <code>Toggle</code> 中。</p>
<p>接著在 render function 中我們使用 <code>Context API</code> 提供的另一個 component <code>Provider</code>，將傳入 <code>Toggle</code> 的 render props 包裹住，並且將 <code>Toggle</code> 本身的 <code>state</code> 或 <code>function</code> 傳到 <code>value</code> 這個 props 中。如此一來，<code>Toggle</code> 底下的所有 children 之後只要將自己用 <code>Toggle.Consumer</code> 包住就可以自由存取 <code>Toggle</code> 傳下來的 <code>value</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Layer1</span> = (<span class="params"></span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">Layer2</span> /&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Layer2</span> = (<span class="params"></span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">Layer3</span> /&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Layer3</span> = (<span class="params"></span>) =&gt; (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Toggle.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;(&#123; on, toggle &#125;) =&gt; (</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;on ? &quot;The button is on&quot; : &quot;The button is off&quot;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;toggle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;on ? &quot;click on&quot; : &quot;click off&quot;&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    )&#125;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Toggle.Consumer</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Layer1</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上面的程式碼可以看到，<code>Toggle</code> component 的 <code>state</code> 與 <code>toggle</code> function 都會被當成 props 傳給被 <code>Toggle.Consumer</code> 包裹著的 children。</p>
<p>包在第三層的 <code>&lt;Layer3 /&gt;</code> 就可以直接拿到想要的 <code>on</code> 與 <code>toggle</code>，再也不用從 <code>Layer1</code> 傳到 <code>Layer2</code> 再傳到 <code>Layer3</code> 了！</p>
<p><a target="_blank" rel="noopener" href="https://codesandbox.io/embed/m3p2p38z5j">Demo Link</a></p>
<h1 id="Higher-order-component"><a href="#Higher-order-component" class="headerlink" title="Higher-order component"></a>Higher-order component</h1><p>最後一個 Pattern 我想是大家最熟悉，也是我認為最需要懂得融會貫通的 <code>Higher-order component</code>，通常簡稱 <code>HOC</code>。旨在解決 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Cross-cutting_concern">Cross-Cutting Concerns</a>，說白一點就是讓你將一些可共用的邏輯抽取出來，讓其他元件透過 <code>HOC</code> 的包裝後，能獲得該共用功能，之後修改新增時不會因為邏輯跟元件綁太緊而出現問題。</p>
<p>雖然很重要，但這個 Pattern 相對簡單，React 官網其實就有<a target="_blank" rel="noopener" href="https://reactjs.org/docs/higher-order-components.html">非常詳細的介紹</a>。這邊就簡單介紹就好，先來個範例吧：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Layer1</span> = (<span class="params"></span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">Layer2</span> /&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Layer2</span> = (<span class="params"></span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">Layer3</span> /&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Layer3</span> = <span class="title function_">withToggle</span>(<span class="function">(<span class="params">&#123;contextProps: &#123; on, toggle &#125;&#125;</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;on ? &quot;The button is on&quot; : &quot;The button is off&quot;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;button1&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;toggle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;on ? &quot;click on&quot; : &quot;click off&quot;&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Fragment</span>&gt;</span></span></span><br><span class="line">));</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Layer4</span> = <span class="title function_">withToggle</span>(<span class="function">(<span class="params">&#123;contextProps: &#123; on, toggle &#125;&#125;</span>) =&gt;</span> (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;button2&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;toggle&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;on ? &quot;click on&quot; : &quot;click off&quot;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;on ? &quot;The button2 is on&quot; : &quot;The button2 is off&quot;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Fragment</span>&gt;</span></span></span><br><span class="line">));</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Layer1</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Layer4</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個範例延續前一個 <code>Provider pattern</code>，我們將 <code>Toggle.Consumer</code> 抽出來，包裝成一個 <code>HOC</code> <code>withToggle</code>，這樣一來，我們可以輕鬆製造出多個擁有 <code>Toggle</code> component 功能與狀態的元件，像是這邊的 <code>Layer3</code> 與 <code>Layer4</code>，他們只需要 care 自己的 UI 邏輯即可，剩下與 <code>Toggle</code> 相關的狀態操作都交由 <code>withToggle</code> 這個 HOC 幫忙處理。</p>
<p>而 <code>withToggle</code> 長這樣：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">withToggle</span>(<span class="params">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">Wrapper</span>(<span class="params">props, ref</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">Toggle.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;toggleContext =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Component</span> <span class="attr">contextProps</span>=<span class="string">&#123;toggleContext&#125;</span> &#123;<span class="attr">...props</span>&#125; <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        )&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Toggle.Consumer</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">Wrapper</span>.<span class="property">displayName</span> = <span class="string">`withToggle(<span class="subst">$&#123;Component.displayName ||</span></span></span><br><span class="line"><span class="subst"><span class="string">    Component.name&#125;</span>)`</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">hoistNonReactStatics</span>(<span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="title class_">Wrapper</span>), <span class="title class_">Component</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是不是很簡單呢！</p>
<p><code>HOC</code> 負責主要的共用邏輯，在這邊就是 <code>Toggle.Consumer</code> 這段，然後將傳入的 <code>Component</code> 塞入，可能是放在 <code>render</code> 或是像這邊是傳入 <code>Consumer</code> 的 children。</p>
<p>特別要注意的有三點，一個是 <code>displayName</code>，由於 <code>HOC</code> 會回傳一個新的 Component，這時如果你沒有明確定義一個 <code>displayName</code> 的話，在 Dev tool 裡你就只能看到一個 <code>Unknown</code> 的元件，會造成開發上的困擾，所以記得要指定一下 <code>displayName</code>，通常會用 <code>HOC</code> 自己的名稱加上原有 Component 的 <code>displayName</code>。</p>
<p>另一個要注意的點是 <code>forwardRef</code>，在 React 中，<code>ref</code> 與 <code>props</code> 的處理方式不相同，<code>ref</code> 並不會如同 props 一般往下傳遞，若你想要取得被 <code>HOC</code> 包裹過的 component 的 <code>ref</code>，那在你的 <code>HOC</code> 中，必須使用 <code>React.forwardRef</code> 將其 forward 下去，詳細介紹可以看<a target="_blank" rel="noopener" href="https://reactjs.org/docs/forwarding-refs.html">官網說明</a>。</p>
<p>最後，假如你原先的 component 有一些 <code>static method</code>，透過 <code>HOC</code> 包裝後，你可能會發現那些 <code>static method</code> 都取不到了！</p>
<p>你必須要在 <code>HOC</code> 中自行複製一份到 <code>HOC</code> 上頭，像這樣（取自 <a target="_blank" rel="noopener" href="https://reactjs.org/docs/higher-order-components.html#static-methods-must-be-copied-over">React 官網</a>)：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">enhance</span>(<span class="params">WrappedComponent</span>) &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Enhance</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line">  <span class="comment">// Must know exactly which method(s) to copy :(</span></span><br><span class="line">  <span class="title class_">Enhance</span>.<span class="property">staticMethod</span> = <span class="title class_">WrappedComponent</span>.<span class="property">staticMethod</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Enhance</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但這樣太麻煩了，我們可以直接利用 <code>hoistNonReactStatics</code> 這套 lib 來幫忙，這樣就萬無一失了！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hoistNonReactStatic <span class="keyword">from</span> <span class="string">&#x27;hoist-non-react-statics&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">enhance</span>(<span class="params">WrappedComponent</span>) &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Enhance</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line">  <span class="title function_">hoistNonReactStatic</span>(<span class="title class_">Enhance</span>, <span class="title class_">WrappedComponent</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Enhance</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://codesandbox.io/embed/q3wmv6okqw">Demo Link</a></p>
<h1 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h1><p>介紹了這麼多種 Pattern，其實我覺得 HOC、Render Props 與 Compound Component 是最需要好好掌握並且多加運用的，其他如 State Reducer、Prop Collections and Getters 則是平常在進行 Code Review 時，可以好好拿出來思考一下是否能夠採用，為你的專案加分。<br>無論如何，經過這樣的學習與紀錄，至少讓自己平日開發時，能主動多思考一些優化的方向與可能性，總體是蠻有收穫的！</p>
<p>最後提供大家 Kent C. Dodds 在 workshop 後自己寫的一篇文章，<a target="_blank" rel="noopener" href="https://blog.kentcdodds.com/mixing-component-patterns-4328f1e26bb5">Mixing Component Patterns</a>，裡頭他將這些 pattern 結合在一起使用，有興趣的讀者可以去看看到底這麼多 Pattern 要怎麼融合使用。</p>
<p>謝謝真的有看到這邊的各位，這些筆記斷斷續續的紀錄，一不小心就篇幅很多…若發現中間有敘述不順或是錯誤的地方，歡迎大家告知！</p>
<h2 id="資料來源"><a href="#資料來源" class="headerlink" title="資料來源"></a>資料來源</h2><ol>
<li><a target="_blank" rel="noopener" href="https://frontendmasters.com/courses/advanced-react-patterns/">Advanced React Patterns workshop</a></li>
<li><a target="_blank" rel="noopener" href="https://codesandbox.io/s/github/kentcdodds/advanced-react-patterns-v2">Advanced React Patterns V2 codesandbox</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.kentcdodds.com/advanced-react-component-patterns-56af2b74bc5f">Advanced React Patterns Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.kentcdodds.com/answers-to-common-questions-about-render-props-a9f84bb12d5d">Answers to common questions about render props</a></li>
<li><a target="_blank" rel="noopener" href="https://hackernoon.com/do-more-with-less-using-render-props-de5bcdfbe74c">Do more with less using render props</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/dailyjs/reacts-%EF%B8%8F-new-context-api-70c9fe01596b">React new context api</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.kentcdodds.com/mixing-component-patterns-4328f1e26bb5">Mixing Component Patterns</a></li>
</ol>
<p>關於作者：<br><a target="_blank" rel="noopener" href="http://blog.arvinh.info/about/">@arvinh</a> 前端攻城獅，熱愛數據分析和資訊視覺化</p>
  
      <div>喜歡我們的文章嗎？歡迎分享按讚給予我們支持和鼓勵！</div>
      <div class="fb-like" data-href="https://blog.techbridge.cc/2018/07/21/advanced-react-component-patterns-note-II/index.html" data-layout="button_count" data-action="like" data-size="large" data-show-faces="false" data-share="true"></div>
      <br>
      <br>
      <div class="fb-page" data-href="https://www.facebook.com/techbridge.cc" data-small-header="false" data-adapt-container-width="true" data-hide-cover="false" data-show-facepile="true"><blockquote cite="https://www.facebook.com/techbridge.cc" class="fb-xfbml-parse-ignore"><a target="_blank" rel="noopener" href="https://www.facebook.com/techbridge.cc">TechBridge 技術日報</a></blockquote></div>
      <br>
    </section>
    <br>
    <hr>
    <div>
      <h4>訂閱 TechBridge Weekly 技術週刊，每週發送最精華的技術開發、產品設計的資訊給您</h4>
      <form class="form-control" method="post" action="https://goodbits.io/e/cab8a418-6b70-48d6-97ea-b5f0ef34b22c" target="_blank">
        <input class="form-control" type="text" name="first_name" placeholder="First Name"></input>
        <input class="form-control" type="text" name="last_name" placeholder="Last Name"></input>
        <div>
          <input class="form-control" type="text" name="email" placeholder="Email"></input>
        </div>
        <br>
        <div>
          <button class="form-control btn subscribe-btn" type="submit">馬上訂閱技術週刊</button>
        </div>
        <br>
        <label for="">PS. 我們討厭垃圾信，所以我們只提供有價值的內容給您 :)</label>
      </form>
    </div>
    <footer class="post-footer">
      <section class="author">
    <h4>TechBridge Weekly 技術週刊編輯團隊</h4>
    <p>TechBridge Weekly 技術週刊團隊是一群對用技術改變世界懷抱熱情的團隊。本技術共筆部落格初期專注於Web前後端、行動網路、機器人/物聯網、資料科學與產品設計等技術分享。This is TechBridge Weekly Team Tech Blog, which focus on web, mobile, robotics, IoT, Data Science technology sharing.</p>
    <span><a href="/2016/03/19/about/">關於我們</a></span> / <span><a href="https://www.techbridge.cc/" target="_blank">技術日報</a></span> / <span><a href="http://weekly.techbridge.cc/" target="_blank">技術週刊</a></span> / <span><a href="https://www.facebook.com/techbridge.cc/" target="_blank">粉絲專頁</a></span> / <span><a href="/atom.xml" target="_blank">訂閱RSS </a></span>   
	<div class="fb-like" data-href="https://www.facebook.com/techbridge.cc" data-layout="button_count" data-size="large" data-action="like" data-show-faces="false" data-share="true"></div>    
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" target="_blank" rel="noopener" href="http://twitter.com/share?url=https://blog.techbridge.cc/2018/07/21/advanced-react-component-patterns-note-II/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" target="_blank" rel="noopener" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.techbridge.cc/2018/07/21/advanced-react-component-patterns-note-II/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" target="_blank" rel="noopener" href="https://plus.google.com/share?url=https://blog.techbridge.cc/2018/07/21/advanced-react-component-patterns-note-II/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
    <iframe src="https://ghbtns.com/github-btn.html?user=TechBridgeHQ&repo=blog-starter-kit&type=star&count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe>      
</section>
    </footer>
    <br>
  </article>
  <nav class="pagination" role="pagination">
    <h2>更多優質技術文章</h2>
    
    <a class="newer-posts" href="/2018/08/04/resrc-for-cognitive-robotics/">
        ← 認知機器人研究資源整理
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2018/07/20/modern-web-2018/">
        Modern Web 2018 簡短心得 →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">留言討論</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75308642-1', 'auto');
  ga('send', 'pageview');

</script>
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="/atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">TechBridge 技術共筆部落格</a> &copy; 2017 &bull; All rights reserved.</section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>


<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '[object Object]']);
    _gaq.push(['_trackPageview']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>


<script type="text/javascript">
    var disqus_shortname = 'techbridgeweekly';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.4/dist/medium-zoom.min.js"></script>
<script>
// NodeList
mediumZoom(document.querySelectorAll('img'));
</script>
  <div id="fb-root"></div>
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>
</body>
</html>
